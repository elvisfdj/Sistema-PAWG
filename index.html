<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAWG ‚Äì Portal de Administra√ß√£o e Workflow de Guias</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/twemoji@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <style>
        /* For√ßa emojis do Twemoji (estilo Twitter) em todos os sistemas */
        img.emoji {
            height: 1.2em;
            width: 1.2em;
            margin: 0 .05em 0 .1em;
            vertical-align: -0.2em;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const ANO_MINIMO = 2018;
const ANO_MAXIMO = 2026;

        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAajyRVH8eR7gWDAF-cE7Y32sKCyH3my8I",
            authDomain: "controle-numeros.firebaseapp.com",
            databaseURL: "https://controle-numeros-default-rtdb.firebaseio.com/",
            projectId: "controle-numeros",
            storageBucket: "controle-numeros.firebasestorage.app",
            messagingSenderId: "95868423352",
            appId: "1:95868423352:web:7968f64d68fc18eb8cb84d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

		const CNAES_VISA = ['0111','0112','0113','0114','0115','0116','0119','0121','0122','0131','0132','0133','0134','0135','0139','0141','0142','0151','0152','0153','0154','0155','0159','0161','0162','0163','0170','0210','0220','0230','0311','0312','0321','0322','0500','0600','0710','0721','0722','0723','0724','0725','0729','0810','0891','0892','0893','0899','0910','0990','1011','1012','1013','1020','1031','1032','1033','1041','1042','1043','1051','1052','1053','1061','1062','1063','1064','1065','1066','1069','1071','1072','1081','1082','1091','1092','1093','1094','1095','1096','1099','1111','1112','1113','1121','1122','1210','1220','1311','1312','1313','1314','1321','1322','1323','1330','1340','1351','1352','1353','1354','1359','1411','1412','1413','1414','1421','1422','1510','1521','1529','1531','1532','1533','1539','1540','1610','1621','1622','1623','1629','1710','1721','1722','1731','1732','1733','1741','1742','1749','1811','1812','1813','1821','1822','1830','1910','1921','1922','1931','1932','2011','2012','2013','2014','2019','2021','2022','2029','2031','2032','2033','2040','2051','2052','2061','2062','2063','2071','2072','2073','2091','2092','2093','2094','2099','2110','2121','2122','2123','2211','2212','2219','2221','2222','2223','2229','2311','2312','2319','2320','2330','2341','2342','2349','2391','2392','2399','2411','2412','2421','2422','2423','2424','2431','2439','2441','2442','2443','2449','2451','2452','2511','2512','2513','2521','2522','2531','2532','2539','2541','2542','2543','2550','2591','2592','2593','2599','2610','2621','2622','2631','2632','2640','2651','2652','2660','2670','2680','2710','2721','2722','2731','2732','2733','2740','2751','2759','2790','2811','2812','2813','2814','2815','2821','2822','2823','2824','2825','2829','2831','2832','2833','2840','2851','2852','2853','2854','2861','2862','2863','2864','2865','2866','2869','2910','2920','2930','2941','2942','2943','2944','2945','2949','2950','3011','3012','3031','3032','3041','3042','3050','3091','3092','3099','3101','3102','3103','3104','3211','3212','3220','3230','3240','3250','3291','3292','3299','3311','3312','3313','3314','3315','3316','3317','3319','3321','3329','3511','3512','3513','3514','3520','3530','3600','3701','3702','3811','3812','3821','3822','3831','3832','3839','3900','4110','4120','4211','4212','4213','4221','4222','4223','4291','4292','4299','4311','4312','4313','4319','4321','4322','4329','4330','4391','4399','4511','4512','4520','4530','4541','4542','4543','4611','4612','4613','4614','4615','4616','4617','4618','4619','4621','4622','4623','4631','4632','4633','4634','4635','4636','4637','4639','4641','4642','4643','4644','4645','4646','4647','4649','4651','4652','4661','4662','4663','4664','4665','4669','4671','4672','4673','4674','4679','4681','4682','4683','4684','4685','4686','4687','4689','4691','4692','4693','4711','4712','4713','4721','4722','4723','4724','4729','4731','4732','4741','4742','4743','4744','4751','4752','4753','4754','4755','4756','4757','4759','4761','4762','4763','4771','4772','4773','4774','4781','4782','4783','4784','4785','4789','4911','4912','4921','4922','4923','4924','4929','4930','4940','4950','5011','5012','5021','5022','5030','5091','5099','5111','5112','5120','5130','5211','5212','5221','5222','5223','5229','5231','5232','5239','5240','5250','5310','5320','5510','5590','5611','5612','5620','5811','5812','5813','5819','5821','5822','5823','5829','5911','5912','5913','5914','5920','6010','6021','6022','6110','6120','6130','6141','6142','6143','6190','6201','6202','6203','6204','6209','6311','6319','6391','6399','6410','6421','6422','6423','6424','6431','6432','6433','6434','6435','6436','6437','6438','6440','6450','6461','6462','6463','6470','6491','6492','6493','6499','6511','6512','6520','6530','6541','6542','6550','6611','6612','6613','6619','6621','6622','6629','6630','6810','6821','6822','6911','6912','6920','7020','7111','7112','7119','7120','7210','7220','7311','7312','7319','7320','7410','7420','7490','7500','7711','7719','7721','7722','7723','7729','7731','7732','7733','7739','7740','7810','7820','7830','7911','7912','7990','8011','8012','8020','8030','8111','8112','8121','8122','8129','8130','8211','8219','8220','8230','8291','8292','8299','8411','8412','8413','8421','8422','8423','8424','8425','8430','8511','8512','8513','8520','8531','8532','8533','8541','8542','8550','8591','8592','8593','8599','8610','8621','8622','8630','8640','8650','8660','8690','8711','8712','8720','8730','8800','9001','9002','9003','9101','9102','9103','9200','9311','9312','9313','9319','9321','9329','9411','9412','9420','9430','9491','9492','9493','9499','9511','9512','9521','9529','9601','9602','9603','9609','9700','9900'];
        const MESES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const AUDITORES = ['Adel A.', 'Alessandro N.', 'Aline P.', 'Amanda V.', 'Carolina S.', 'Erick J.', 'Fagne A.', 'Gabriel S.', 'Igor B.', 'Jennipher A.', 'Matheus C.', 'Nahttura P.', 'Natalia C.', 'Natalia G.', 'Pedro A.', 'Raphael O.', 'Rodrigo R.', 'Thiago S.', 'Tiago M.'];
        const VALOR_UFICA_2026 = 179.50;

        const TABELA_VISA = [
            { min: 0, max: 50, valorIntegral: 143.60, valorME_EPP: 71.80 },
            { min: 51, max: 100, valorIntegral: 179.50, valorME_EPP: 89.75 },
            { min: 101, max: 150, valorIntegral: 269.25, valorME_EPP: 134.63 },
            { min: 151, max: 200, valorIntegral: 359.00, valorME_EPP: 179.50 },
            { min: 201, max: 300, valorIntegral: 448.75, valorME_EPP: 224.38 },
            { min: 301, max: 350, valorIntegral: 538.50, valorME_EPP: 269.25 },
            { min: 351, max: 400, valorIntegral: 628.25, valorME_EPP: 314.13 },
            { min: 401, max: 500, valorIntegral: 718.00, valorME_EPP: 359.00 },
            { min: 501, max: 600, valorIntegral: 807.75, valorME_EPP: 403.88 },
            { min: 601, max: 1000, valorIntegral: 897.50, valorME_EPP: 448.75 },
            { min: 1001, max: 1500, valorIntegral: 1077.00, valorME_EPP: 538.50 },
            { min: 1501, max: Infinity, valorIntegral: 1256.50, valorME_EPP: 628.25 }
        ];


        // ============================================
        // ERROR BOUNDARY - Captura erros React
        // ============================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('üö® Erro capturado:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                            <div className="bg-white rounded-lg shadow-2xl p-8 max-w-lg">
                                <div className="text-center mb-6">
                                    <div className="text-7xl mb-4">‚ö†Ô∏è</div>
                                    <h1 className="text-3xl font-bold text-red-600 mb-3">Erro na Aplica√ß√£o</h1>
                                    <p className="text-gray-700 text-lg">Ocorreu um erro inesperado.</p>
                                </div>
                                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-6">
                                    <p className="text-sm text-red-900 font-mono break-all">
                                        {this.state.error?.message || 'Erro desconhecido'}
                                    </p>
                                </div>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="w-full bg-red-600 text-white px-6 py-4 rounded-lg hover:bg-red-700 font-bold text-lg shadow-lg"
                                >
                                    üîÑ Recarregar P√°gina
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }
        function App() {
            const [auth, setAuth] = useState(false);
            const [loading, setLoading] = useState(true);
            const [tab, setTab] = useState('doc');
            const [valorUfica, setValorUfica] = useState({ 2026: 179.50, 2027: 0, 2028: 0, 2029: 0, 2030: 0 });

            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                    setAuth(!!user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                try {
                    await firebase.auth().signOut();
                    setAuth(false);
                } catch (error) {
                    console.error('Erro ao sair:', error);
                    alert('Erro ao fazer logout');
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700">
                    <div className="text-center">
                        <div className="animate-spin h-16 w-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p className="text-white text-lg">Carregando...</p>
                    </div>
                </div>
            );

            if (!auth) return <Login onLogin={() => setAuth(true)} />;

            return (
                <div>
                    <nav className="bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <h1 className="text-white font-bold text-xl">üíª PAWG ‚Äì Portal de Administra√ß√£o e Workflow de Guias</h1>
                            <div className="flex gap-4">
                                <button onClick={() => setTab('doc')} className={`px-4 py-2 rounded-lg font-medium ${tab === 'doc' ? 'bg-white text-blue-600' : 'text-white hover:bg-blue-500'}`}>üìã Documentos</button>
                                <button onClick={() => setTab('tax')} className={`px-4 py-2 rounded-lg font-medium ${tab === 'tax' ? 'bg-white text-blue-600' : 'text-white hover:bg-blue-500'}`}>üëΩ Contribuintes</button>
                                <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium">üö™ Sair</button>
                            </div>
                        </div>
                    </nav>
                    {tab === 'doc' ? <Docs /> : <Taxas valorUfica={valorUfica} setValorUfica={setValorUfica} />}
                    <footer className="bg-white border-t mt-8">
                        <div className="max-w-7xl mx-auto px-4 py-6 text-center">
                            <p className="text-gray-700 font-semibold mb-2">üíª Desenvolvido por <span className="text-blue-600">Elvis Ferreira</span></p>
                            <div className="flex flex-col sm:flex-row items-center justify-center gap-2 text-sm text-gray-600">
                                <a href="mailto:elvis.fdj@aol.com" className="hover:text-blue-600">üìß elvis.fdj@aol.com</a>
                                <span className="hidden sm:inline">‚Ä¢</span>
                                <a href="tel:+5522981382619" className="hover:text-blue-600">üì± (22) 98138-2619</a>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        function Login({ onLogin }) {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [e, setE] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (ev) => {
                ev.preventDefault();
                setLoading(true);
                setE('');

                try {
                    await firebase.auth().signInWithEmailAndPassword(u, p);
                    onLogin();
                } catch (error) {
                    console.error('Erro de autentica√ß√£o:', error);
                    if (error.code === 'auth/user-not-found') setE('‚ùå Usu√°rio n√£o encontrado');
                    else if (error.code === 'auth/wrong-password') setE('‚ùå Senha incorreta');
                    else if (error.code === 'auth/invalid-email') setE('‚ùå Email inv√°lido');
                    else if (error.code === 'auth/too-many-requests') setE('‚ùå Muitas tentativas. Aguarde alguns minutos');
                    else setE('‚ùå Erro ao fazer login. Verifique suas credenciais');
                    setP('');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen relative overflow-hidden flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-700">
                        <div className="absolute inset-0 opacity-30">
                            <div className="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl animate-blob"></div>
                            <div className="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-2000"></div>
                            <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-4000"></div>
                        </div>
                    </div>

                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 w-2 h-2 bg-white rounded-full opacity-20 animate-float"></div>
                        <div className="absolute top-1/3 right-1/4 w-3 h-3 bg-white rounded-full opacity-30 animate-float animation-delay-1000"></div>
                        <div className="absolute bottom-1/4 left-1/3 w-2 h-2 bg-white rounded-full opacity-25 animate-float animation-delay-2000"></div>
                        <div className="absolute top-2/3 right-1/3 w-2 h-2 bg-white rounded-full opacity-20 animate-float animation-delay-3000"></div>
                    </div>

                    <div className="relative z-10 w-full max-w-md">
                        <div className="backdrop-blur-xl bg-white/90 rounded-3xl shadow-2xl p-10 border border-white/20 transform transition-all duration-300 hover:scale-[1.02]">
                            <div className="text-center mb-8">
                                <div className="relative inline-block mb-6">
                                    <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full blur-lg opacity-50 animate-pulse"></div>
                                    <div className="relative bg-gradient-to-br from-indigo-500 to-purple-600 w-24 h-24 rounded-full flex items-center justify-center shadow-lg transform transition-transform duration-300 hover:rotate-12">
                                        <span className="text-5xl animate-bounce-slow">üíª</span>
                                    </div>
                                </div>
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                                    PAWG ‚Äì Portal de Administra√ß√£o e Workflow de Guias
                                </h1>
                                <p className="text-gray-600 font-medium">Controle Geral e Gest√£o</p>
                                <div className="mt-4 flex items-center justify-center gap-2 text-sm text-gray-500">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span>Sistema Online</span>
                                </div>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-5">
                                <div className="group">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <span className="text-lg">üìß</span> Email
                                    </label>
                                    <input
                                        type="email"
                                        value={u}
                                        onChange={(ev) => setU(ev.target.value)}
                                        placeholder="seu.email@exemplo.com"
                                        className="w-full px-5 py-4 bg-white border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all duration-300 outline-none disabled:opacity-50 disabled:cursor-not-allowed group-hover:border-indigo-300"
                                        required
                                        disabled={loading}
                                    />
                                </div>

                                <div className="group">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <span className="text-lg">üîë</span> Senha
                                    </label>
                                    <input
                                        type="password"
                                        value={p}
                                        onChange={(ev) => setP(ev.target.value)}
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        className="w-full px-5 py-4 bg-white border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all duration-300 outline-none disabled:opacity-50 disabled:cursor-not-allowed group-hover:border-indigo-300"
                                        required
                                        disabled={loading}
                                    />
                                </div>

                                {e && (
                                    <div className="bg-red-50 border-2 border-red-200 text-red-700 px-5 py-4 rounded-xl text-sm font-medium flex items-center gap-3 animate-shake">
                                        <span className="text-xl">‚ö†Ô∏è</span> <span>{e}</span>
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 font-bold text-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 active:translate-y-0"
                                    disabled={loading}
                                >
                                    {loading ? (
                                        <>
                                            <svg className="animate-spin h-6 w-6" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span>Autenticando...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span className="text-2xl">üîì</span>
                                            <span>Entrar no Sistema</span>
                                        </>
                                    )}
                                </button>
                            </form>

                            <div className="mt-8 pt-6 border-t border-gray-200">
                                <div className="flex items-center justify-center gap-2 text-xs text-gray-500">
                                    <span className="text-lg">üîí</span>
                                    <span className="font-medium">Protegido por Firebase Authentication</span>
                                </div>
                            </div>
                        </div>

                        <div className="mt-6 text-center">
                            <p className="text-white/80 text-sm font-medium drop-shadow-lg">
                                üíª Desenvolvido por Elvis Ferreira
                            </p>
                        </div>
                    </div>

                    <style>{`
                        @keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
                        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
                        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
                        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
                        .animate-blob { animation: blob 7s infinite; }
                        .animate-float { animation: float 3s ease-in-out infinite; }
                        .animate-bounce-slow { animation: bounce-slow 2s ease-in-out infinite; }
                        .animate-shake { animation: shake 0.3s ease-in-out; }
                        .animation-delay-1000 { animation-delay: 1s; }
                        .animation-delay-2000 { animation-delay: 2s; }
                        .animation-delay-3000 { animation-delay: 3s; }
                        .animation-delay-4000 { animation-delay: 4s; }
                    `}</style>
                </div>
            );
        }

        function Docs() {
            const [docs, setDocs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editando, setEditando] = useState(null);
            const [filtros, setFiltros] = useState({ tipo: 'TODOS', setor: '', dataInicio: '', dataFim: '' });
            const [form, setForm] = useState({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
            const year = new Date().getFullYear();

            useEffect(() => {
                const ref = db.ref('documentos/' + year);
                ref.on('value', (snap) => {
                    const data = snap.val();
                    setDocs(data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : []);
                    setLoading(false);
                });
                return () => ref.off();
            }, []);

            const add = async () => {
                if (!form.setorOrigem.trim()) return alert('Preencha o Setor de Origem');
                const num = docs.filter(d => d.tipo === form.tipo).length + 1;
                await db.ref('documentos/' + year).push({ ...form, numero: `${String(num).padStart(4, '0')}/${year}`, criadoEm: Date.now(), criadoPor: 'SAR' });
                setForm({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
                alert('‚úÖ Documento adicionado!');
            };

            const update = async (id) => {
                await db.ref('documentos/' + year + '/' + id).update({ ...editando, editadoEm: Date.now(), editadoPor: 'SAR' });
                setEditando(null);
                alert('‚úÖ Documento atualizado!');
            };

            const del = async (id) => {
                if (confirm('Excluir documento?')) {
                    await db.ref('documentos/' + year + '/' + id).remove();
                }
            };

            const formatDate = (dateStr) => {
                const [y, m, d] = dateStr.split('-');
                return new Date(y, m - 1, d).toLocaleDateString('pt-BR');
            };

            const exportCSV = () => {
                const headers = ['Tipo', 'N√∫mero', 'Data', 'Setor Origem', 'Setor Destino', 'Observa√ß√£o'];
                const rows = docsFiltrados.map(d => [d.tipo, d.numero, formatDate(d.data), d.setorOrigem, d.setorDestino || '', d.obs || '']);
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `documentos_${year}.csv`;
                link.click();
            };

            const docsFiltrados = docs.filter(d => {
                const tipoOk = filtros.tipo === 'TODOS' || d.tipo === filtros.tipo;
                const setorOk = !filtros.setor || d.setorOrigem.toLowerCase().includes(filtros.setor.toLowerCase()) || (d.setorDestino && d.setorDestino.toLowerCase().includes(filtros.setor.toLowerCase()));
                const dataOk = (!filtros.dataInicio || d.data >= filtros.dataInicio) && (!filtros.dataFim || d.data <= filtros.dataFim);
                return tipoOk && setorOk && dataOk;
            });

            const stats = {
                total: docsFiltrados.length,
                EDITAL: docsFiltrados.filter(d => d.tipo === 'EDITAL').length,
                OFICIO: docsFiltrados.filter(d => d.tipo === 'OFICIO').length,
                MEMORANDO: docsFiltrados.filter(d => d.tipo === 'MEMORANDO').length
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin h-16 w-16 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold">üìù Controle de Numera√ß√£o - {year}</h2>
                                <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Exportar CSV</button>
                            </div>

                            <div className="grid md:grid-cols-4 gap-4 mb-6">
                                <select value={filtros.tipo} onChange={(e) => setFiltros({ ...filtros, tipo: e.target.value })} className="px-3 py-2 border rounded-lg">
                                    <option value="TODOS">Todos os Tipos</option>
                                    <option value="EDITAL">EDITAL</option>
                                    <option value="OFICIO">OF√çCIO</option>
                                    <option value="MEMORANDO">MEMORANDO</option>
                                </select>
                                <input type="text" value={filtros.setor} onChange={(e) => setFiltros({ ...filtros, setor: e.target.value })} placeholder="Buscar por setor..." className="px-3 py-2 border rounded-lg" />
                                <input type="date" value={filtros.dataInicio} onChange={(e) => setFiltros({ ...filtros, dataInicio: e.target.value })} className="px-3 py-2 border rounded-lg" />
                                <input type="date" value={filtros.dataFim} onChange={(e) => setFiltros({ ...filtros, dataFim: e.target.value })} className="px-3 py-2 border rounded-lg" />
                            </div>

                            <div className="grid md:grid-cols-4 gap-4">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                    <div className="text-sm text-blue-600 font-medium">Total</div>
                                    <div className="text-3xl font-bold text-blue-700">{stats.total}</div>
                                </div>
                                <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                    <div className="text-sm text-green-600 font-medium">EDITAL</div>
                                    <div className="text-3xl font-bold text-green-700">{stats.EDITAL}</div>
                                </div>
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                    <div className="text-sm text-purple-600 font-medium">OF√çCIO</div>
                                    <div className="text-3xl font-bold text-purple-700">{stats.OFICIO}</div>
                                </div>
                                <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                    <div className="text-sm text-orange-600 font-medium">MEMORANDO</div>
                                    <div className="text-3xl font-bold text-orange-700">{stats.MEMORANDO}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h3 className="text-xl font-bold mb-4">‚ûï Novo Documento</h3>
                            <div className="grid md:grid-cols-3 gap-4">
                                <select value={form.tipo} onChange={(e) => setForm({ ...form, tipo: e.target.value })} className="px-3 py-2 border rounded-lg">
                                    <option>EDITAL</option>
                                    <option>OFICIO</option>
                                    <option>MEMORANDO</option>
                                </select>
                                <input type="date" value={form.data} onChange={(e) => setForm({ ...form, data: e.target.value })} className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorOrigem} onChange={(e) => setForm({ ...form, setorOrigem: e.target.value })} placeholder="Setor Origem *" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorDestino} onChange={(e) => setForm({ ...form, setorDestino: e.target.value })} placeholder="Setor Destino" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.obs} onChange={(e) => setForm({ ...form, obs: e.target.value })} placeholder="Observa√ß√£o" className="px-3 py-2 border rounded-lg md:col-span-2" />
                            </div>
                            <button onClick={add} className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">‚ûï Adicionar</button>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left">Tipo</th>
                                            <th className="px-4 py-3 text-left">N√∫mero</th>
                                            <th className="px-4 py-3 text-left">Data</th>
                                            <th className="px-4 py-3 text-left">Origem</th>
                                            <th className="px-4 py-3 text-left">Destino</th>
                                            <th className="px-4 py-3 text-left">Observa√ß√£o</th>
                                            <th className="px-4 py-3 text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {docsFiltrados.length === 0 ? (
                                            <tr><td colSpan="7" className="px-4 py-8 text-center text-gray-500">Nenhum documento encontrado</td></tr>
                                        ) : (
                                            docsFiltrados.slice().reverse().map((d, i) => (
                                                <tr key={d.id} className={i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                                    {editando?.id === d.id ? (
                                                        <>
                                                            <td className="px-4 py-3"><select value={editando.tipo} onChange={(e) => setEditando({ ...editando, tipo: e.target.value })} className="px-2 py-1 border rounded w-full"><option>EDITAL</option><option>OFICIO</option><option>MEMORANDO</option></select></td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3"><input type="date" value={editando.data} onChange={(e) => setEditando({ ...editando, data: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorOrigem} onChange={(e) => setEditando({ ...editando, setorOrigem: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorDestino || ''} onChange={(e) => setEditando({ ...editando, setorDestino: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.obs || ''} onChange={(e) => setEditando({ ...editando, obs: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => update(d.id)} className="text-green-600 hover:text-green-800 mr-2 text-xl">‚úì</button>
                                                                <button onClick={() => setEditando(null)} className="text-gray-600 hover:text-gray-800 text-xl">‚úó</button>
                                                            </td>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <td className="px-4 py-3 font-semibold text-blue-600">{d.tipo}</td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3">{formatDate(d.data)}</td>
                                                            <td className="px-4 py-3">{d.setorOrigem}</td>
                                                            <td className="px-4 py-3">{d.setorDestino || '-'}</td>
                                                            <td className="px-4 py-3 text-sm">{d.obs || '-'}</td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => setEditando(d)} className="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button>
                                                                <button onClick={() => del(d.id)} className="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                                                            </td>
                                                        </>
                                                    )}
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Taxas({ valorUfica, setValorUfica }) {
            const [list, setList] = useState([]);
            const [mes, setMes] = useState(new Date().getMonth());
            const [ano, setAno] = useState(new Date().getFullYear());
            const [consultandoQueue, setConsultandoQueue] = useState([]);
            const [consultasRealizadas, setConsultasRealizadas] = useState(0);
            const [ultimaConsulta, setUltimaConsulta] = useState(null);
            const [abaAtiva, setAbaAtiva] = useState('principal');
            const [modalInserir, setModalInserir] = useState(false);
            const [formInserir, setFormInserir] = useState({ inscricao: '', documento: '', nome: '' });
            const [modalInserirFalta, setModalInserirFalta] = useState(false);
            const [faltaSelecionada, setFaltaSelecionada] = useState(null);
            const [modoVisualizacao, setModoVisualizacao] = useState('mensal');
            const [periodoInicio, setPeriodoInicio] = useState(0);
            const [periodoFim, setPeriodoFim] = useState(11);
            const [marcadores, setMarcadores] = useState({});
            const [menuCorAberto, setMenuCorAberto] = useState(null);

            // ‚îÄ‚îÄ Estados para Faltas e Ordena√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [faltas, setFaltas] = useState([]);
            const [consultandoFaltas, setConsultandoFaltas] = useState(false);
            const [carregandoFaltas, setCarregandoFaltas] = useState(true);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            // ‚îÄ‚îÄ Estados para Filtros Avan√ßados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [filtros, setFiltros] = useState({
                busca: '',
                auditor: '',
                situacao: '',
                tributacao: '',
                apenasVerificados: false,
                apenasPendentes: false
            });

            // ‚îÄ‚îÄ Estados para intervalo din√¢mico ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const [intervaloInicio, setIntervaloInicio] = useState('');
            const [intervaloFim, setIntervaloFim] = useState('');

            const valorUficaAtual = valorUfica[ano] || VALOR_UFICA_2026;

            useEffect(() => {
                const carregarDados = async () => {
                    try {
                        console.log('üîÑ Carregando:', { modoVisualizacao, ano, mes });
                        
                        if (modoVisualizacao === 'mensal') {
                            // Modo mensal: carregar apenas o m√™s selecionado
                            const chave = `contribuintes/${ano}/${mes}`;
                            const snapshot = await db.ref(chave).once('value');
                            const data = snapshot.val();
                            
                            // ‚úÖ VALIDA√á√ÉO: Verificar se data existe e √© objeto
                            if (data && typeof data === 'object') {
                                const lista = Object.entries(data)
                                    .filter(([k, v]) => v && typeof v === 'object')
                                    .map(([k, v]) => ({ id: k, ...v }));
                                setList(lista);

                                const marks = {};
                                lista.forEach(item => {
                                    if (item && item.marcador) marks[item.id] = item.marcador;
                                });
                                setMarcadores(marks);

                                const inscricoesNumericas = lista
                                    .filter(item => item && item.inscricaoMunicipal)
                                    .map(item => item.inscricaoMunicipal.trim())
                                    .filter(insc => insc && !isNaN(insc))
                                    .map(insc => Number(insc));

                                if (inscricoesNumericas.length > 0) {
                                    const minInscricao = Math.min(...inscricoesNumericas);
                                    const maxInscricao = Math.max(...inscricoesNumericas);
                                    setIntervaloInicio(String(minInscricao));
                                    setIntervaloFim(String(maxInscricao));
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Sem dados para', chave);
                                setList([]);
                                setMarcadores({});
                            }
                            
                        } else if (modoVisualizacao === 'anual') {
                            // Modo anual: carregar todos os meses do ano
                            const listaCombinada = [];
                            const marksCombinados = {};
                            
                            for (let m = 0; m <= 11; m++) {
                                const snapshot = await db.ref(`contribuintes/${ano}/${m}`).once('value');
                                const data = snapshot.val();
                                
                                // ‚úÖ VALIDA√á√ÉO: Verificar se data existe e √© objeto
                                if (data && typeof data === 'object') {
                                    Object.entries(data).forEach(([k, v]) => {
                                        // ‚úÖ VALIDA√á√ÉO: Verificar se v √© objeto v√°lido
                                        if (v && typeof v === 'object') {
                                            listaCombinada.push({ id: k, ...v, mesOrigem: m });
                                            if (v.marcador) marksCombinados[k] = v.marcador;
                                        }
                                    });
                                }
                            }
                            
                            console.log('‚úÖ Anual:', listaCombinada.length, 'registros');
                            setList(listaCombinada);
                            setMarcadores(marksCombinados);
                            
                        } else if (modoVisualizacao === 'periodo') {
                            // Modo per√≠odo: carregar meses do per√≠odo selecionado
                            const listaCombinada = [];
                            const marksCombinados = {};
                            
                            // ‚úÖ VALIDA√á√ÉO: Garantir valores v√°lidos
                            const inicio = Math.min(Math.max(0, periodoInicio || 0), 11);
                            const fim = Math.min(Math.max(0, periodoFim || 11), 11);
                            const mesInicio = Math.min(inicio, fim);
                            const mesFim = Math.max(inicio, fim);
                            
                            for (let m = mesInicio; m <= mesFim; m++) {
                                const snapshot = await db.ref(`contribuintes/${ano}/${m}`).once('value');
                                const data = snapshot.val();
                                
                                // ‚úÖ VALIDA√á√ÉO: Verificar se data existe e √© objeto
                                if (data && typeof data === 'object') {
                                    Object.entries(data).forEach(([k, v]) => {
                                        // ‚úÖ VALIDA√á√ÉO: Verificar se v √© objeto v√°lido
                                        if (v && typeof v === 'object') {
                                            listaCombinada.push({ id: k, ...v, mesOrigem: m });
                                            if (v.marcador) marksCombinados[k] = v.marcador;
                                        }
                                    });
                                }
                            }
                            
                            console.log('‚úÖ Per√≠odo:', listaCombinada.length, 'registros');
                            setList(listaCombinada);
                            setMarcadores(marksCombinados);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar dados:', error);
                        // ‚úÖ N√ÉO deixar tela branca - mostrar lista vazia
                        setList([]);
                        setMarcadores({});
                        alert('Erro ao carregar dados do ano ' + ano + ':\n' + error.message);
                    }
                };
                
                carregarDados();
            }, [mes, ano, modoVisualizacao, periodoInicio, periodoFim]);

            // Carregar faltas do Firebase
            useEffect(() => {
                setCarregandoFaltas(true);
                const chaveFaltas = `contribuintes/_faltas_${ano}_${mes}`;
                const refFaltas = db.ref(chaveFaltas);
                
                console.log('üîÑ Carregando faltas de:', chaveFaltas);
                
                const listener = refFaltas.on('value', (snap) => {
                    const data = snap.val();
                    console.log('üì• Dados de faltas recebidos:', data);
                    
                    if (data) {
                        const listaFaltas = Object.entries(data).map(([k, v]) => ({ id: k, ...v }));
                        console.log('üìã Faltas processadas:', listaFaltas.length, 'itens');
                        setFaltas(listaFaltas);
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma falta encontrada no Firebase');
                        setFaltas([]);
                    }
                    setCarregandoFaltas(false);
                });
                
                return () => {
                    console.log('üîå Desconectando listener de faltas');
                    refFaltas.off('value', listener);
                };
            }, [mes, ano]);
            
            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const getSortedList = () => {
                // ‚úÖ SEMPRE ordenar por inscri√ß√£o municipal crescente
                return [...list].sort((a, b) => {
                    const inscA = Number(a.inscricaoMunicipal) || 0;
                    const inscB = Number(b.inscricaoMunicipal) || 0;
                    return inscA - inscB;
                });
            };

            const consultarFaltas = async () => {
                setConsultandoFaltas(true);
                setFaltas([]);

                if (!intervaloInicio || !intervaloFim || isNaN(intervaloInicio) || isNaN(intervaloFim)) {
                    alert('Preencha os campos "In√≠cio" e "Fim" com n√∫meros v√°lidos.');
                    setConsultandoFaltas(false);
                    return;
                }

                const inicio = Number(intervaloInicio);
                const fim = Number(intervaloFim);

                if (inicio > fim) {
                    alert('O in√≠cio deve ser menor ou igual ao fim.');
                    setConsultandoFaltas(false);
                    return;
                }

                if (fim - inicio > 2000) {
                    alert('Intervalo muito grande (> 2000 itens). Por favor, reduza.');
                    setConsultandoFaltas(false);
                    return;
                }

                try {
                    const inscricoesExistentesNoAno = new Set();

                    for (let m = 0; m <= 11; m++) {
                        const chave = `contribuintes/${ano}/${m}`;
                        const snapshot = await db.ref(chave).once('value');
                        const data = snapshot.val();
                        if (data) {
                            Object.values(data).forEach(item => {
                                const inscr = item.inscricaoMunicipal?.trim();
                                if (inscr && inscr !== '') {
                                    inscricoesExistentesNoAno.add(inscr);
                                }
                            });
                        }
                    }

                    const inscricoesMesAtual = new Set(
                        list
                            .filter(item => item.inscricaoMunicipal?.trim())
                            .map(item => item.inscricaoMunicipal.trim())
                    );

                    const intervaloEsperado = new Set();
                    for (let i = inicio; i <= fim; i++) {
                        intervaloEsperado.add(String(i));
                    }

                    const faltandoNoMes = [...intervaloEsperado].filter(inscr => !inscricoesMesAtual.has(inscr));

                    const faltasComInfo = [];

                    for (const inscr of faltandoNoMes) {
                        let encontradoEmOutroMes = null;
                        let mesEncontrado = null;

                        for (let m = 0; m <= 11; m++) {
                            if (m === mes) continue;
                            const chave = `contribuintes/${ano}/${m}`;
                            const snap = await db.ref(chave)
                                .orderByChild('inscricaoMunicipal')
                                .equalTo(inscr)
                                .limitToFirst(1)
                                .once('value');

                            const val = snap.val();
                            if (val) {
                                encontradoEmOutroMes = Object.values(val)[0];
                                mesEncontrado = m;
                                break;
                            }
                        }

                        faltasComInfo.push({
                            inscricaoMunicipal: inscr,
                            documento: encontradoEmOutroMes?.documento || '-',
                            razaoSocial: encontradoEmOutroMes?.razaoSocial || 'N√£o encontrado',
                            status: encontradoEmOutroMes 
                                ? `Existe em ${MESES[mesEncontrado]}/${ano}` 
                                : 'N√£o cadastrada em nenhum m√™s deste ano',
                        });
                    }

                    setFaltas(faltasComInfo);

                    // ‚úÖ SALVAR AS FALTAS NO FIREBASE
                    const chaveFaltas = `contribuintes/_faltas_${ano}_${mes}`;
                    console.log('üíæ Salvando faltas no Firebase:', chaveFaltas);
                    
                    // Limpar faltas antigas deste m√™s/ano primeiro
                    await db.ref(chaveFaltas).remove();
                    
                    // Salvar cada falta
                    for (const falta of faltasComInfo) {
                        await db.ref(chaveFaltas).push(falta);
                    }
                    
                    console.log('‚úÖ Faltas salvas com sucesso no Firebase!');

                    if (faltasComInfo.length === 0) {
                        alert(`Nenhuma falta no intervalo ${inicio}‚Äì${fim} para ${MESES[mes]}/${ano}.`);
                    } else {
                        alert(`Encontradas ${faltasComInfo.length} faltas no intervalo informado!`);
                    }
                } catch (err) {
                    console.error('Erro ao consultar faltas:', err);
                    alert('Erro ao consultar faltas: ' + err.message);
                } finally {
                    setConsultandoFaltas(false);
                }
            };

            const salvarNoFirebase = async (contribuinte) => {
                const chave = `contribuintes/${ano}/${mes}`;
                await db.ref(chave).push(contribuinte);
            };

            const consultarCNPJ = async (cnpj, id) => {
                try {
                    console.log('üîç Iniciando consulta CNPJ:', cnpj, 'ID:', id);
                    
                    if (ultimaConsulta) {
                        const tempoDecorrido = Date.now() - ultimaConsulta.getTime();
                        if (tempoDecorrido < 12000) {
                            const espera = 12000 - tempoDecorrido;
                            console.log('‚è≥ Aguardando', espera, 'ms antes de consultar...');
                            await new Promise(resolve => setTimeout(resolve, espera));
                        }
                    }

                    const url = `https://open.cnpja.com/office/${cnpj}`;
                    console.log('üì° Fazendo request para:', url);
                    
                    const response = await fetch(url);
                    console.log('üì• Response status:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Erro na resposta:', errorText);
                        throw new Error(`Erro na consulta: ${response.status} - ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ Dados recebidos:', data);

                    let porte = '';
                    if (data.company?.size?.acronym) {
                        porte = data.company.size.acronym;
                    } else if (data.company?.size?.text) {
                        const porteText = data.company.size.text.toUpperCase();
                        if (porteText.includes('MICRO')) porte = 'ME';
                        else if (porteText.includes('PEQUENO')) porte = 'ME';
                        else porte = 'DEMAIS';
                    }

                    let tributacao = '';
                    if (data.company?.simei?.optant) {
                        tributacao = 'MEI';
                    } else if (porte === 'ME') {
                        tributacao = 'SIMPLES';
                    } else if (data.company?.simples?.optant && porte === 'DEMAIS') {
                        tributacao = 'SIMPLES';
                    } else if (porte === 'DEMAIS' && !data.company?.simples?.optant) {
                        tributacao = 'LUCRO PRESUMIDO';
                    } else {
                        tributacao = 'LUCRO PRESUMIDO';
                    }

                    let situacao = data.status?.text || '';

                    const cnaes = [];
                    if (data.mainActivity?.id) {
                        const cnaeStr = String(data.mainActivity.id);
                        cnaes.push(cnaeStr.substring(0, 4));
                    }
                    if (data.sideActivities) {
                        data.sideActivities.forEach(sec => {
                            if (sec.id) {
                                const cnaeStr = String(sec.id);
                                cnaes.push(cnaeStr.substring(0, 4));
                            }
                        });
                    }

                    const precisaVisa = cnaes.some(cnae => CNAES_VISA.includes(cnae));

                    const atualizado = { porte, tributacao, situacao, precisaVisa, verificado: true, dadosAPI: data };
                    
                    console.log('üíæ Atualizando com:', atualizado);

                    setList(prevList => prevList.map(item =>
                        item.id === id ? { ...item, ...atualizado } : item
                    ));

                    await db.ref(`contribuintes/${ano}/${mes}/${id}`).update(atualizado);

                    setConsultasRealizadas(prev => prev + 1);
                    setUltimaConsulta(new Date());

                    console.log('‚úÖ Consulta conclu√≠da com sucesso!');
                    return { success: true, porte, tributacao, situacao };
                } catch (error) {
                    console.error('‚ùå ERRO AO CONSULTAR CNPJ:', error);
                    console.error('‚ùå Stack:', error.stack);
                    alert(`Erro ao consultar CNPJ ${cnpj}:\n${error.message}\n\nVerifique o Console (F12) para mais detalhes.`);
                    return { success: false, error: error.message };
                }
            };

            const consultarTodos = async () => {
                const naoConsultados = list.filter(l => !l.verificado && l.tipoPessoa === 'CNPJ');

                if (naoConsultados.length === 0) {
                    alert('Todos os CNPJs j√° foram consultados!');
                    return;
                }

                setConsultandoQueue(naoConsultados.map(l => l.id));

                for (let i = 0; i < naoConsultados.length; i++) {
                    const item = naoConsultados[i];
                    await consultarCNPJ(item.documento, item.id);
                    if (i < naoConsultados.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 12000));
                    }
                }

                setConsultandoQueue([]);
                alert(`‚úÖ ${naoConsultados.length} CNPJs consultados!`);
            };

            const toggleMarcador = async (id, cor) => {
                const novosMarcadores = { ...marcadores, [id]: cor };
                setMarcadores(novosMarcadores);
                await db.ref(`contribuintes/${ano}/${mes}/${id}`).update({ marcador: cor });
            };

            const calcISSQN = (nivel, trimestre, isento, tipoPessoa) => {
                if (isento || tipoPessoa !== 'CPF' || nivel === 'VARIAVEL') return 0;
                const base = nivel === 'SUPERIOR' ? 8 : 5;
                const trimestres = 4 - (trimestre - 1);
                return (base / 4) * trimestres;
            };

            const calcVISA = (area, tributacao, porte, precisaVisa) => {
                if (tributacao === 'MEI' || tributacao === 'ISENTO' || !precisaVisa) return 0;
                if (!area || area === 0) return 0;

                const faixa = TABELA_VISA.find(f => area >= f.min && area <= f.max);
                if (!faixa) return 0;

                if (tributacao === 'SIMPLES') return faixa.valorME_EPP;
                return faixa.valorIntegral;
            };

            const getPorteUFICAS = (tributacao, tipoPessoa) => {
                if (tributacao === 'MEI' || tributacao === 'ISENTO') return 0;

                const valores = {
                    'MEI': 0,
                    'SIMPLES': 2.5,
                    'EPP': 2.5,
                    'LUCRO PRESUMIDO': 8,
                    'LUCRO REAL': 20,
                    'AUTONOMO': 2.5,
                    'ISENTO': 0
                };

                if (tipoPessoa === 'CPF') return 2.5;
                return valores[tributacao] || 0;
            };

            const calcTFLFReais = (tributacao, tipoPessoa) => {
                const uficas = getPorteUFICAS(tributacao, tipoPessoa);
                return uficas * valorUficaAtual;
            };

            const calcDashboard = () => {
                let listaCalculo = list;

                const total = listaCalculo.length;
                const pendentes = listaCalculo.filter(l => l.taxasLancadas === 'NAO' && l.tributacao !== 'MEI').length;
                const verificados = listaCalculo.filter(l => l.verificado).length;

                const documentos = {};
                const duplicados = [];
                listaCalculo.forEach(l => {
                    if (documentos[l.documento]) duplicados.push(l.documento);
                    documentos[l.documento] = (documentos[l.documento] || 0) + 1;
                });
                const totalDuplicados = new Set(duplicados).size;

                let totalUFICAS = 0;
                let totalReais = 0;
                let totalISSQN = 0;

                listaCalculo.forEach(l => {
                    const uficas = getPorteUFICAS(l.tributacao, l.tipoPessoa);
                    const reais = uficas * valorUficaAtual;
                    const issqn = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);

                    totalUFICAS += uficas;
                    totalReais += reais;
                    totalISSQN += issqn * valorUficaAtual;
                });

                const vigilancia = listaCalculo.reduce((sum, l) => sum + calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa), 0);

                return { total, pendentes, verificados, totalUFICAS, totalReais, vigilancia, totalDuplicados, totalISSQN };
            };

            const formatarMoeda = (valor) => {
                return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            const inserirManual = async () => {
                if (!formInserir.documento.trim() || !formInserir.nome.trim()) {
                    alert('Preencha pelo menos Documento e Nome!');
                    return;
                }

                const clean = formInserir.documento.replace(/\D/g, '');
                const novo = {
                    inscricaoMunicipal: formInserir.inscricao || '',
                    documento: clean,
                    tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                    razaoSocial: formInserir.nome,
                    porte: '',
                    tributacao: clean.length === 11 ? 'AUTONOMO' : '',
                    situacao: '',
                    areaM2: 0,
                    ordemServico: '',
                    nivelISSQN: clean.length === 11 ? 'MEDIO' : 'VARIAVEL',
                    issqnIsento: false,
                    trimestreAbertura: 1,
                    taxasLancadas: 'NAO',
                    verificado: false,
                    precisaVisa: false,
                    criadoEm: Date.now()
                };

                await salvarNoFirebase(novo);
                setFormInserir({ inscricao: '', documento: '', nome: '' });
                setModalInserir(false);
                alert('‚úÖ Contribuinte adicionado!');
            };

            const importarTXT = (file) => {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const linhas = e.target.result.split('\n');
                    let novos = 0;
                    let ignorados = 0;

                    const docsVerificados = new Set(list.filter(l => l.verificado).map(l => l.documento));

                    for (const l of linhas) {
                        if (!l.trim()) continue;

                        const partes = l.split('\t').map(p => p.trim());
                        const [insc, doc, nome] = partes;

                        if (!doc) continue;

                        const clean = doc.replace(/\D/g, '');

                        if (docsVerificados.has(clean)) {
                            ignorados++;
                            continue;
                        }

                        const contribuinte = {
                            inscricaoMunicipal: insc || '',
                            documento: clean,
                            tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                            razaoSocial: nome || '',
                            porte: '',
                            areaM2: 0,
                            nivelISSQN: 'MEDIO',
                            issqnIsento: false,
                            trimestreAbertura: 1,
                            taxasLancadas: 'NAO',
                            verificado: false,
                            criadoEm: Date.now()
                        };

                        await salvarNoFirebase(contribuinte);
                        novos++;
                    }

                    alert(`‚úÖ ${novos} contribuintes importados!\n‚è≠Ô∏è ${ignorados} j√° verificados foram ignorados.`);
                };

                reader.readAsText(file);
            };

            const exportCSV = () => {
                const header = ['Inscri√ß√£o', 'Documento', 'Identifica√ß√£o do Contribuinte', 'Porte', 'Tributa√ß√£o', 'N¬∞ OS', 'Auditor', 'TFLF (R$)', 'ISSQN (R$)', 'VISA (R$)', 'Verificado', 'Taxas Lan√ßadas'];
                const rows = list.map(l => {
                    const tflf = calcTFLFReais(l.tributacao, l.tipoPessoa);
                    const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                    const issqnReais = issqnUficas * valorUficaAtual;
                    const visa = calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa);

                    return [
                        l.inscricaoMunicipal,
                        l.documento,
                        l.razaoSocial,
                        l.porte || '',
                        l.tributacao || '',
                        l.ordemServico || '',
                        l.auditor || '',
                        tflf.toFixed(2),
                        issqnReais.toFixed(2),
                        visa.toFixed(2),
                        l.verificado ? 'SIM' : 'NAO',
                        l.taxasLancadas
                    ];
                });

                const csv = [header, ...rows].map(r => r.join(';')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `taxas_${MESES[mes]}_${ano}.csv`;
                a.click();
            };

            // ============================================
            // FUN√á√ÉO DE BACKUP COMPLETO
            // ============================================
            const fazerBackup = async () => {
                try {
                    const confirmacao = confirm('üíæ Deseja fazer backup completo dos dados?\n\nIsso salvar√° TODOS os contribuintes de todos os meses/anos.');
                    if (!confirmacao) return;

                    const dados = {};
                    
                    // Backup de contribuintes de todos os anos/meses
                    const anosParaBackup = [2024, 2025, 2026, 2027];
                    
                    for (const anoBackup of anosParaBackup) {
                        dados[`contribuintes_${anoBackup}`] = {};
                        
                        for (let mesBackup = 0; mesBackup <= 11; mesBackup++) {
                            const snapshot = await db.ref(`contribuintes/${anoBackup}/${mesBackup}`).once('value');
                            const dadosMes = snapshot.val();
                            if (dadosMes) {
                                dados[`contribuintes_${anoBackup}`][MESES[mesBackup]] = dadosMes;
                            }
                        }
                    }
                    
                    // Backup de faltas
                    for (const anoBackup of anosParaBackup) {
                        for (let mesBackup = 0; mesBackup <= 11; mesBackup++) {
                            const snapshotFaltas = await db.ref(`contribuintes/_faltas_${anoBackup}_${mesBackup}`).once('value');
                            const dadosFaltas = snapshotFaltas.val();
                            if (dadosFaltas) {
                                if (!dados.faltas) dados.faltas = {};
                                dados.faltas[`${anoBackup}_${mesBackup}`] = dadosFaltas;
                            }
                        }
                    }
                    
                    // Criar arquivo JSON para download
                    const dataStr = JSON.stringify(dados, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    const dataHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    link.download = `backup_pawg_${dataHora}.json`;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Backup realizado com sucesso!\n\nArquivo salvo: backup_pawg_' + dataHora + '.json');
                } catch (error) {
                    console.error('Erro ao fazer backup:', error);
                    alert('‚ùå Erro ao fazer backup: ' + error.message);
                }
            };

            // ============================================
            // FUN√á√ÉO DE RESTAURA√á√ÉO DE BACKUP
            // ============================================
            const restaurarBackup = async (arquivo) => {
                try {
                    const confirmacao = confirm('‚ö†Ô∏è ATEN√á√ÉO: Restaurar backup pode sobrescrever dados atuais!\n\nTem certeza que deseja continuar?');
                    if (!confirmacao) return;

                    const texto = await arquivo.text();
                    const dados = JSON.parse(texto);
                    
                    let totalRestaurado = 0;
                    
                    // Restaurar contribuintes
                    for (const [chave, valor] of Object.entries(dados)) {
                        if (chave.startsWith('contribuintes_')) {
                            const anoRestore = chave.split('_')[1];
                            for (const [mesNome, dadosMes] of Object.entries(valor)) {
                                const mesIndex = MESES.indexOf(mesNome);
                                if (mesIndex !== -1) {
                                    await db.ref(`contribuintes/${anoRestore}/${mesIndex}`).set(dadosMes);
                                    totalRestaurado++;
                                }
                            }
                        } else if (chave === 'faltas') {
                            for (const [periodo, dadosFaltas] of Object.entries(valor)) {
                                const [anoF, mesF] = periodo.split('_');
                                await db.ref(`contribuintes/_faltas_${anoF}_${mesF}`).set(dadosFaltas);
                            }
                        }
                    }
                    
                    alert(`‚úÖ Backup restaurado com sucesso!\n\n${totalRestaurado} per√≠odos restaurados.\n\nA p√°gina ser√° recarregada.`);
                    window.location.reload();
                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    alert('‚ùå Erro ao restaurar: ' + error.message);
                }
            };

            // ============================================
            // FUN√á√ÉO DE FILTROS AVAN√áADOS
            // ============================================
            const aplicarFiltros = (lista) => {
                let listaFiltrada = [...lista];
                
                // Filtro de busca (nome, documento, inscri√ß√£o)
                if (filtros.busca) {
                    const buscaLower = filtros.busca.toLowerCase();
                    listaFiltrada = listaFiltrada.filter(item => 
                        (item.razaoSocial && item.razaoSocial.toLowerCase().includes(buscaLower)) ||
                        (item.nomeContribuinte && item.nomeContribuinte.toLowerCase().includes(buscaLower)) ||
                        (item.documento && item.documento.includes(filtros.busca)) ||
                        (item.inscricaoMunicipal && item.inscricaoMunicipal.includes(filtros.busca))
                    );
                }
                
                // Filtro por auditor
                if (filtros.auditor) {
                    listaFiltrada = listaFiltrada.filter(item => item.auditor === filtros.auditor);
                }
                
                // Filtro por situa√ß√£o
                if (filtros.situacao) {
                    listaFiltrada = listaFiltrada.filter(item => item.status === filtros.situacao);
                }
                
                // Filtro por tributa√ß√£o
                if (filtros.tributacao) {
                    listaFiltrada = listaFiltrada.filter(item => item.tributacao === filtros.tributacao);
                }
                
                // Apenas verificados
                if (filtros.apenasVerificados) {
                    listaFiltrada = listaFiltrada.filter(item => item.verificado);
                }
                
                // Apenas pendentes de lan√ßamento
                if (filtros.apenasPendentes) {
                    listaFiltrada = listaFiltrada.filter(item => item.taxasLancadas === 'NAO');
                }
                
                return listaFiltrada;
            };

            const limparFiltros = () => {
                setFiltros({
                    busca: '',
                    auditor: '',
                    situacao: '',
                    tributacao: '',
                    apenasVerificados: false,
                    apenasPendentes: false
                });
            };

            const update = async (id, campo, valor) => {
                setList(list.map(item =>
                    item.id === id ? { ...item, [campo]: valor } : item
                ));
                await db.ref(`contribuintes/${ano}/${mes}/${id}`).update({ [campo]: valor });
            };

            const excluir = async (id) => {
                if (confirm('Tem certeza que deseja excluir?')) {
                    await db.ref(`contribuintes/${ano}/${mes}/${id}`).remove();
                }
            };

            const getDuplicados = () => {
                const documentos = {};
                list.forEach(l => {
                    if (!documentos[l.documento]) documentos[l.documento] = [];
                    documentos[l.documento].push(l);
                });
                return Object.values(documentos).filter(grupo => grupo.length > 1).flat();
            };

            const dashboard = calcDashboard();

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="mb-6">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="text-3xl">üíµ</span>
                            <h2 className="text-2xl font-bold">Lan√ßamento de Taxas</h2>
                        </div>

                        <div className="flex gap-4 mb-4 flex-wrap items-center">
                            <select value={modoVisualizacao} onChange={e => setModoVisualizacao(e.target.value)} className="px-4 py-2 border rounded bg-white min-w-[180px]">
                                <option value="mensal">üìÖ Mensal</option>
                                <option value="anual">üìä Consolidado Anual</option>
                                <option value="periodo">üìÜ Por Per√≠odo</option>
                            </select>

                            {modoVisualizacao === 'mensal' && (
                                <select value={mes} onChange={e => setMes(Number(e.target.value))} className="px-4 py-2 border rounded bg-white min-w-[140px]">
                                    {MESES.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                </select>
                            )}

                            {modoVisualizacao === 'periodo' && (
                                <>
                                    <select value={periodoInicio} onChange={e => setPeriodoInicio(Number(e.target.value))} className="px-4 py-2 border rounded bg-white min-w-[140px]">
                                        {MESES.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                    </select>
                                    <span className="flex items-center text-gray-600 font-medium">at√©</span>
                                    <select value={periodoFim} onChange={e => setPeriodoFim(Number(e.target.value))} className="px-4 py-2 border rounded bg-white min-w-[140px]">
                                        {MESES.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                    </select>
                                </>
                            )}

                            <select value={ano} onChange={e => setAno(Number(e.target.value))} className="px-4 py-2 border rounded bg-white min-w-[100px]">
                                {[2026, 2027, 2028, 2029, 2030].map(a => <option key={a} value={a}>{a}</option>)}
                            </select>

                            <div className="px-4 py-2 bg-blue-50 text-blue-700 rounded border border-blue-200 font-medium min-w-[180px] text-center">
                                {modoVisualizacao === 'mensal' && `${MESES[mes]}/${ano}`}
                                {modoVisualizacao === 'anual' && `Ano ${ano}`}
                                {modoVisualizacao === 'periodo' && `${MESES[periodoInicio]} - ${MESES[periodoFim]}/${ano}`}
                            </div>

                            {ano >= 2027 ? (
                                <div className="flex items-center gap-2 bg-green-50 border border-green-200 rounded px-3 py-2">
                                    <label className="text-sm text-green-700 font-medium">üíµ UFICA {ano}:</label>
                                    <input type="number" step="0.01" value={valorUfica[ano] || ''} onChange={e => setValorUfica({ ...valorUfica, [ano]: parseFloat(e.target.value) || 0 })} className="px-3 py-1 border rounded w-32 text-sm" placeholder="0.00" />
                                </div>
                            ) : (
                                <div className="px-4 py-2 bg-green-50 text-green-700 rounded border border-green-200 text-sm">
                                    üíµ UFICA {ano}: R$ {formatarMoeda(valorUficaAtual)}
                                </div>
                            )}

                            <div className="flex items-end gap-4 ml-auto">
                                <div>
                                    <label className="block text-sm text-gray-700 font-medium">In√≠cio intervalo</label>
                                    <input
                                        type="number"
                                        value={intervaloInicio}
                                        onChange={e => setIntervaloInicio(e.target.value)}
                                        placeholder="Ex: 154610"
                                        className="px-2 py-2 border rounded bg-white w-28"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-700 font-medium">Fim intervalo</label>
                                    <input
                                        type="number"
                                        value={intervaloFim}
                                        onChange={e => setIntervaloFim(e.target.value)}
                                        placeholder="Ex: 154694"
                                        className="px-2 py-2 border rounded bg-white w-28"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-7 gap-4 mb-6">
                            <div className="bg-white rounded-lg p-4 border">
                                <div className="text-sm text-gray-600 mb-1">Total</div>
                                <div className="text-3xl font-bold text-gray-800">{dashboard.total}</div>
                            </div>
                            <div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                <div className="text-sm text-gray-600 mb-1">Pendentes</div>
                                <div className="text-3xl font-bold text-yellow-600">{dashboard.pendentes}</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                <div className="text-sm text-gray-600 mb-1">‚úÖ Verificados</div>
                                <div className="text-3xl font-bold text-green-600">{dashboard.verificados}</div>
                            </div>
                            <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                <div className="text-sm text-gray-600 mb-1">‚ö†Ô∏è Duplicados</div>
                                <div className="text-3xl font-bold text-orange-600">{dashboard.totalDuplicados}</div>
                            </div>
                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <div className="text-sm text-gray-600 mb-1">Total TFLF</div>
                                <div className="text-3xl font-bold text-blue-600">R$ {formatarMoeda(dashboard.totalReais)}</div>
                            </div>
                            <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                                <div className="text-sm text-gray-600 mb-1">Total ISSQN</div>
                                <div className="text-3xl font-bold text-indigo-600">R$ {formatarMoeda(dashboard.totalISSQN)}</div>
                            </div>
                            <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                <div className="text-sm text-gray-600 mb-1">Vigil√¢ncia</div>
                                <div className="text-3xl font-bold text-purple-600">R$ {formatarMoeda(dashboard.vigilancia)}</div>
                            </div>
                        </div>


                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                            <div className="flex gap-2 mb-4 border-b overflow-x-auto">
                                <button onClick={() => setAbaAtiva('principal')} className={`px-4 py-2 font-medium ${abaAtiva === 'principal' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'}`}>
                                    üìã Principal ({list.filter(l => l.tributacao !== 'MEI' && l.tributacao !== 'AUTONOMO').length})
                                </button>
                                <button onClick={() => setAbaAtiva('mei')} className={`px-4 py-2 font-medium ${abaAtiva === 'mei' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-600'}`}>
                                    üè™ MEI ({list.filter(l => l.tributacao === 'MEI').length})
                                </button>
                                <button onClick={() => setAbaAtiva('autonomo')} className={`px-4 py-2 font-medium ${abaAtiva === 'autonomo' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-600'}`}>
                                    üßîüèΩ Aut√¥nomo ({list.filter(l => l.tributacao === 'AUTONOMO').length})
                                </button>
                                <button onClick={() => setAbaAtiva('visa')} className={`px-4 py-2 font-medium ${abaAtiva === 'visa' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600'}`}>
                                    üè• VISA ({list.filter(l => l.precisaVisa).length})
                                </button>
                                <button onClick={() => setAbaAtiva('duplicados')} className={`px-4 py-2 font-medium ${abaAtiva === 'duplicados' ? 'text-orange-600 border-b-2 border-orange-600' : 'text-gray-600'}`}>
                                    ‚ö†Ô∏è Duplicidade ({dashboard.totalDuplicados})
                                </button>
                                <button onClick={() => setAbaAtiva('Faltas')} className={`px-4 py-2 font-medium ${abaAtiva === 'Faltas' ? 'text-red-600 border-b-2 border-red-600' : 'text-gray-600'}`}>
                                    üì¢ Faltas ({faltas.length})
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-4">
                                <button onClick={() => setModalInserir(true)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    ‚ûï Inserir
                                </button>

                                <label className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded cursor-pointer hover:bg-indigo-700">
                                    <span>üìÅ Importar TXT</span>
                                    <input type="file" accept=".txt" onChange={e => importarTXT(e.target.files[0])} className="hidden" />
                                </label>

                                <button onClick={consultarTodos} className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700" disabled={consultandoQueue.length > 0}>
                                    {consultandoQueue.length > 0 ? 'üîÑ Consultando...' : 'üîç Consultar CNPJs'}
                                </button>

                                <button
                                    onClick={consultarFaltas}
                                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                    disabled={consultandoFaltas}
                                >
                                    {consultandoFaltas ? 'üîÑ Buscando...' : 'üïµÔ∏è Consultar Faltas'}
                                </button>

                                <button onClick={exportCSV} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    Exportar CSV
                                </button>

                                <button onClick={fazerBackup} className="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                                    üíæ Backup
                                </button>

                                <label className="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded cursor-pointer hover:bg-orange-700">
                                    <span>üì• Restaurar</span>
                                    <input type="file" accept=".json" onChange={e => { if (e.target.files[0]) restaurarBackup(e.target.files[0]); }} className="hidden" />
                                </label>
                            </div>
                        </div>


                        {modoVisualizacao !== 'mensal' && (
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <div className="flex">
                                    <div className="flex-shrink-0">
                                        <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                    </div>
                                    <div className="ml-3">
                                        <p className="text-sm text-yellow-700">
                                            <strong>Modo de visualiza√ß√£o {modoVisualizacao === 'anual' ? 'Anual' : 'por Per√≠odo'}:</strong> Voc√™ est√° vendo dados consolidados. Algumas fun√ß√µes (inserir, importar, consultar faltas) est√£o desabilitadas. Volte ao modo "Mensal" para editar.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            {modalInserir && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                        <h3 className="text-xl font-bold mb-4">‚ûï Inserir Contribuinte</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Inscri√ß√£o Municipal</label>
                                                <input type="text" value={formInserir.inscricao} onChange={e => setFormInserir({ ...formInserir, inscricao: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Opcional" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">CPF/CNPJ *</label>
                                                <input type="text" value={formInserir.documento} onChange={e => setFormInserir({ ...formInserir, documento: e.target.value })} className="w-full px-3 py-2 border rounded" required />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nome/Raz√£o Social *</label>
                                                <input type="text" value={formInserir.nome} onChange={e => setFormInserir({ ...formInserir, nome: e.target.value })} className="w-full px-3 py-2 border rounded" required />
                                            </div>
                                        </div>
                                        <div className="flex gap-2 mt-6">
                                            <button onClick={inserirManual} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‚úì Confirmar</button>
                                            <button onClick={() => { setModalInserir(false); setFormInserir({ inscricao: '', documento: '', nome: '' }); }} className="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‚úó Cancelar</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {modalInserirFalta && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                        <h3 className="text-xl font-bold mb-4">‚ûï Inserir Contribuinte</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Inscri√ß√£o Municipal</label>
                                                <input 
                                                    type="text" 
                                                    value={formInserir.inscricao} 
                                                    className="w-full px-3 py-2 border rounded bg-gray-100" 
                                                    placeholder="Opcional"
                                                    readOnly
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">CPF/CNPJ *</label>
                                                <input 
                                                    type="text" 
                                                    value={formInserir.documento} 
                                                    onChange={e => setFormInserir({ ...formInserir, documento: e.target.value })} 
                                                    className="w-full px-3 py-2 border rounded" 
                                                    required 
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nome/Raz√£o Social *</label>
                                                <input 
                                                    type="text" 
                                                    value={formInserir.nome} 
                                                    onChange={e => setFormInserir({ ...formInserir, nome: e.target.value })} 
                                                    className="w-full px-3 py-2 border rounded" 
                                                    required 
                                                />
                                            </div>
                                        </div>
                                        <div className="flex gap-2 mt-6">
                                            <button 
                                                onClick={async () => {
                                                    if (!formInserir.documento.trim() || !formInserir.nome.trim()) {
                                                        alert('‚ùå Preencha pelo menos Documento e Nome!');
                                                        return;
                                                    }
                                                    
                                                    const clean = formInserir.documento.replace(/\D/g, '');
                                                    const novo = {
                                                        inscricaoMunicipal: formInserir.inscricao || '',
                                                        documento: clean,
                                                        tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                                                        razaoSocial: formInserir.nome,
                                                        porte: '',
                                                        tributacao: clean.length === 11 ? 'AUTONOMO' : '',
                                                        situacao: '',
                                                        areaM2: 0,
                                                        ordemServico: '',
                                                        nivelISSQN: clean.length === 11 ? 'MEDIO' : 'VARIAVEL',
                                                        issqnIsento: false,
                                                        trimestreAbertura: 1,
                                                        taxasLancadas: 'NAO',
                                                        verificado: false,
                                                        precisaVisa: false,
                                                        criadoEm: Date.now()
                                                    };
                                                    
                                                    
                                                    const ref = await db.ref(`contribuintes/${ano}/${mes}`).push(novo);
                                                    
                                                    // ‚úÖ Adicionar √† lista local IMEDIATAMENTE
                                                    setList(prev => [...prev, { id: ref.key, ...novo }]);
                                                    
                                                    // ‚úÖ Remover da lista de faltas
                                                    setFaltas(prev => prev.filter(f => f.inscricaoMunicipal !== formInserir.inscricao));
                                                    
                                                    setModalInserirFalta(false);
                                                    setFaltaSelecionada(null);
                                                    setFormInserir({ inscricao: '', documento: '', nome: '' });
                                                    alert('‚úÖ Contribuinte inserido com sucesso!');
                                                }} 
                                                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                            >
                                                ‚úì Confirmar
                                            </button>
                                            <button 
                                                onClick={() => { 
                                                    setModalInserirFalta(false); 
                                                    setFaltaSelecionada(null);
                                                    setFormInserir({ inscricao: '', documento: '', nome: '' }); 
                                                }} 
                                                className="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                                            >
                                                ‚úó Cancelar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-indigo-600 text-white">
                                        <tr>
                                            <th className="px-3 py-2 text-left " >
                                                Status 
                                            </th>
                                            <th className="px-3 py-2 text-left " >
                                                Cor 
                                            </th>
                                            <th className="px-3 py-2 text-left " >
                                                Inscri√ß√£o 
                                            </th>
                                            <th className="px-3 py-2 text-left " >
                                                Documento 
                                            </th>
                                            <th className="px-3 py-2 text-left " >
                                                Identifica√ß√£o do Contribuinte 
                                            </th>
                                            <th className="px-3 py-2 text-left " >
                                                Situa√ß√£o 
                                            </th>
                                            <th className="px-3 py-2">Porte</th>
                                            <th className="px-3 py-2">Tributa√ß√£o</th>
                                            <th className="px-3 py-2">VISA?</th>
                                            <th className="px-3 py-2">√Årea m¬≤</th>
                                            <th className="px-3 py-2">N¬∞ OS</th>
                                            <th className="px-3 py-2">Auditor</th>
                                            <th className="px-3 py-2">Trimestre</th>
                                            <th className="px-3 py-2">N√≠vel</th>
                                            <th className="px-3 py-2">TFLF</th>
                                            <th className="px-3 py-2">ISSQN</th>
                                            <th className="px-3 py-2">VISA R$</th>
                                            <th className="px-3 py-2">Lan√ßado</th>
											<th className="px-3 py-2">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(() => {
                                            let listaExibir = getSortedList();
                                            
                                            // ‚úÖ APLICAR FILTROS AVAN√áADOS
                                            listaExibir = aplicarFiltros(listaExibir);

                                            
                                            // Mostrar contador de registros filtrados
                                            const totalFiltrado = listaExibir.length;
                                            const totalGeral = list.length;
                                            const filtrosAtivos = filtros.busca || filtros.auditor || filtros.situacao || 
                                                                  filtros.tributacao || filtros.apenasVerificados || filtros.apenasPendentes;
                                            if (abaAtiva === 'principal') {
                                                listaExibir = listaExibir.filter(l => l.tributacao !== 'MEI' && l.tributacao !== 'AUTONOMO');
                                            } else if (abaAtiva === 'mei') {
                                                listaExibir = listaExibir.filter(l => l.tributacao === 'MEI');
                                            } else if (abaAtiva === 'autonomo') {
                                                listaExibir = listaExibir.filter(l => l.tributacao === 'AUTONOMO');
                                            } else if (abaAtiva === 'visa') {
                                                listaExibir = listaExibir.filter(l => l.precisaVisa);
                                            } else if (abaAtiva === 'duplicados') {
                                                listaExibir = aplicarFiltros(getDuplicados());
                                            } else if (abaAtiva === 'Faltas') {
                                                if (faltas.length === 0) {
                                                    return (
                                                        <tr>
                                                            <td colSpan="20" className="px-4 py-8 text-center text-gray-500">
                                                                Clique em "Consultar Faltas" para verificar inscri√ß√µes ausentes neste m√™s.
                                                            </td>
                                                        </tr>
                                                    );
                                                }

                                                return faltas.map((falta, idx) => (
                                                    <tr key={idx} className="bg-red-50 border-t hover:bg-red-100">
                                                        <td className="px-3 py-2 text-center">‚ùó</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2 font-medium">{falta.inscricaoMunicipal}</td>
                                                        <td className="px-3 py-2 font-mono">{falta.documento}</td>
                                                        <td className="px-3 py-2">{falta.razaoSocial}</td>
                                                        <td className="px-3 py-2 text-center">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2 text-center">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2 text-right">-</td>
                                                        <td className="px-3 py-2 text-right">-</td>
                                                        <td className="px-3 py-2 text-right">-</td>
                                                        <td className="px-3 py-2">-</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <button 
                                                                onClick={() => {
                                                                    setFaltaSelecionada(falta);
                                                                    setFormInserir({
                                                                        inscricao: falta.inscricaoMunicipal || '',
                                                                        documento: falta.documento || '',
                                                                        nome: falta.razaoSocial !== 'N√£o encontrado' ? falta.razaoSocial : ''
                                                                    });
                                                                    setModalInserirFalta(true);
                                                                }}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                                                            >
                                                                ‚ûï
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ));
                                            }

                                            if (listaExibir.length === 0) {
                                                return (
                                                    <tr>
                                                        <td colSpan="20" className="px-4 py-8 text-center text-gray-500">
                                                            {abaAtiva === 'duplicados' ? '‚úÖ Nenhum duplicado!' : 'Nenhum contribuinte nesta aba.'}
                                                        </td>
                                                    </tr>
                                                );
                                            }

                                            return listaExibir.map(l => {
                                                const tflf = calcTFLFReais(l.tributacao, l.tipoPessoa);
                                                const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                                                const issqnReais = issqnUficas * valorUficaAtual;
                                                const visa = calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa);
                                                const consultando = consultandoQueue.includes(l.id);
                                                const isDuplicado = getDuplicados().some(d => d.id === l.id);

                                                const getRowBgColor = () => {
                                                    if (marcadores[l.id] === 'red') return 'bg-red-100';
                                                    if (marcadores[l.id] === 'yellow') return 'bg-yellow-100';
                                                    if (marcadores[l.id] === 'green') return 'bg-green-100';
                                                    if (marcadores[l.id] === 'blue') return 'bg-blue-100';
                                                    if (marcadores[l.id] === 'purple') return 'bg-purple-100';
                                                    if (marcadores[l.id] === 'orange') return 'bg-orange-100';
                                                    if (isDuplicado && abaAtiva === 'duplicados') return 'bg-orange-50';
                                                    return '';
                                                };

                                                return (
                                                    <tr key={l.id} className={`border-t hover:bg-gray-50 ${getRowBgColor()}`}>
                                                        <td className="px-3 py-2 text-center">
                                                            {consultando ? <span className="text-blue-600">üîÑ</span> :
                                                             l.verificado ? <span className="text-green-600">‚úÖ</span> :
                                                             isDuplicado ? <span className="text-orange-600">‚ö†Ô∏è</span> :
                                                             <span className="text-gray-400">üïò</span>}
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <div className="relative">
                                                                <button
                                                                    onClick={() => setMenuCorAberto(menuCorAberto === l.id ? null : l.id)}
                                                                    className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-400"
                                                                    style={{ backgroundColor: marcadores[l.id] || '#e5e7eb' }}
                                                                />
                                                                {menuCorAberto === l.id && (
                                                                    <div className="absolute z-10 mt-1 bg-white border rounded shadow-lg p-2 flex gap-1">
                                                                        {['red', 'yellow', 'green', 'blue', 'purple', 'orange'].map(cor => (
                                                                            <button
                                                                                key={cor}
                                                                                onClick={() => {
                                                                                    toggleMarcador(l.id, marcadores[l.id] === cor ? null : cor);
                                                                                    setMenuCorAberto(null);
                                                                                }}
                                                                                className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-800"
                                                                                style={{ backgroundColor: cor }}
                                                                            />
                                                                        ))}
                                                                        <button
                                                                            onClick={() => { toggleMarcador(l.id, null); setMenuCorAberto(null); }}
                                                                            className="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-800 bg-white text-xs"
                                                                        >‚úï</button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2">{l.inscricaoMunicipal}</td>
                                                        <td className="px-3 py-2 font-mono">{l.documento}</td>
                                                        <td className="px-3 py-2">{l.razaoSocial}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${l.situacao === 'Ativa' ? 'bg-green-100 text-green-800 border border-green-300' :
                                                                l.situacao === 'Suspensa' ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' :
                                                                l.situacao === 'Inapta' ? 'bg-orange-100 text-orange-800 border border-orange-300' :
                                                                l.situacao === 'Baixada' ? 'bg-red-100 text-red-800 border border-red-300' :
                                                                l.situacao === 'Nula' ? 'bg-purple-100 text-purple-800 border border-purple-300' :
                                                                'bg-gray-100 text-gray-700 border border-gray-300'}`}>
                                                                {l.situacao || '-'}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.porte || ''} onChange={e => update(l.id, 'porte', e.target.value)} className="px-2 py-1 border rounded bg-white text-xs" disabled={l.tipoPessoa === 'CPF'}>
                                                                <option value="">-</option>
                                                                <option value="MEI">MEI</option>
                                                                <option value="ME">ME</option>
                                                                <option value="DEMAIS">DEMAIS</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.tributacao || ''} onChange={e => update(l.id, 'tributacao', e.target.value)} className="px-2 py-1 border rounded bg-white text-xs">
                                                                <option value="">Selecione</option>
                                                                <option value="SIMPLES">Simples</option>
                                                                <option value="LUCRO PRESUMIDO">L. Presumido</option>
                                                                <option value="LUCRO REAL">L. Real</option>
                                                                <option value="AUTONOMO">Aut√¥nomo</option>
                                                                <option value="ISENTO">Isento</option>
                                                                <option value="MEI">MEI</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <input type="checkbox" checked={l.precisaVisa || false} onChange={e => update(l.id, 'precisaVisa', e.target.checked)} className="w-4 h-4" />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <input type="number" value={l.areaM2 || ''} onChange={e => update(l.id, 'areaM2', Number(e.target.value))} className="px-2 py-1 border rounded w-16 text-xs" disabled={!l.precisaVisa} />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <input type="text" value={l.ordemServico || ''} onChange={e => update(l.id, 'ordemServico', e.target.value)} placeholder="N¬∞ OS" className="px-2 py-1 border rounded w-20 text-xs" />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.auditor || ''} onChange={e => update(l.id, 'auditor', e.target.value)} className="px-2 py-1 border rounded text-xs bg-white">
                                                                <option value="">Selecione</option>
                                                                {AUDITORES.map((aud, idx) => <option key={idx} value={aud}>{aud}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            {l.tipoPessoa === 'CNPJ' ? (
                                                                <span className="text-center text-gray-500">-</span>
                                                            ) : (
                                                                <select value={l.trimestreAbertura || 1} onChange={e => update(l.id, 'trimestreAbertura', Number(e.target.value))} className="px-2 py-1 border rounded text-xs bg-white">
                                                                    <option value={1}>1¬∞</option>
                                                                    <option value={2}>2¬∞</option>
                                                                    <option value={3}>3¬∞</option>
                                                                    <option value={4}>4¬∞</option>
                                                                </select>
                                                            )}
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.nivelISSQN} onChange={e => update(l.id, 'nivelISSQN', e.target.value)} className="px-2 py-1 border rounded text-xs" disabled={l.tipoPessoa === 'CNPJ'}>
                                                                {l.tipoPessoa === 'CNPJ' ? <option value="VARIAVEL">Vari√°vel</option> : <><option value="MEDIO">M√©dio</option><option value="SUPERIOR">Superior</option></>}
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(tflf)}</td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(issqnReais)}</td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(visa)}</td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.taxasLancadas} onChange={e => update(l.id, 'taxasLancadas', e.target.value)} className={`px-2 py-1 border rounded text-xs ${l.taxasLancadas === 'SIM' ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}`}>
                                                                <option value="NAO">N√ÉO</option>
                                                                <option value="SIM">SIM</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <button onClick={() => excluir(l.id)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs mr-1">üóëÔ∏è</button>
                                                            {l.tipoPessoa === 'CNPJ' && !l.verificado && <button onClick={() => consultarCNPJ(l.documento, l.id)} className="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">üîç</button>}
                                                        </td>
                                                    </tr>
                                                );
                                            });
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
        
        // Converte todos os emojis para Twemoji ap√≥s renderiza√ß√£o
        const observer = new MutationObserver(() => {
            twemoji.parse(document.body, {
                folder: 'svg',
                ext: '.svg'
            });
        });
        
        observer.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
        
        // Convers√£o inicial
        setTimeout(() => twemoji.parse(document.body, {
            folder: 'svg',
            ext: '.svg'
        }), 100);
    </script>
</body>

</html>
