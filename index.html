<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Municipal - Controle Geral</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAajyRVH8eR7gWDAF-cE7Y32sKCyH3my8I",
            authDomain: "controle-numeros.firebaseapp.com",
            databaseURL: "https://controle-numeros-default-rtdb.firebaseio.com/",
            projectId: "controle-numeros",
            storageBucket: "controle-numeros.firebasestorage.app",
            messagingSenderId: "95868423352",
            appId: "1:95868423352:web:7968f64d68fc18eb8cb84d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const CNAES_VISA = ['4711', '4712', '4721', '4722', '4723', '4724', '4729', '5611', '5612', '5620', '8610', '8621', '8622', '8630', '8640', '8650', '1011', '1012', '1013', '1020', '1031', '1032', '1033', '4631', '4632', '4633', '4634', '4635', '4636', '4637', '4639', '1051', '1052', '1053', '1061', '1062', '1063', '1064', '1065', '1066', '1069', '1071', '1072', '4781', '4782', '4783', '4784', '4785', '4789', '8711', '8712', '8720', '8730', '8800', '4771', '4772', '4773', '4774'];
        const MESES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const AUDITORES = ['Adel A.', 'Alessandro N.', 'Aline P.', 'Amanda V.', 'Carolina S.', 'Erick J.', 'Fagne A.', 'Gabriel S.', 'Igor B.', 'Jennipher A.', 'Matheus C.', 'Nahttura P.', 'Natalia C.', 'Natalia G.', 'Pedro A.', 'Raphael O.', 'Rodrigo R.', 'Thiago S.', 'Tiago M.'];
        const VALOR_UFICA_2026 = 179.50;

        const TABELA_VISA = [
            { min: 0, max: 50, valorIntegral: 143.60, valorME_EPP: 71.80 },
            { min: 51, max: 100, valorIntegral: 179.50, valorME_EPP: 89.75 },
            { min: 101, max: 150, valorIntegral: 269.25, valorME_EPP: 134.63 },
            { min: 151, max: 200, valorIntegral: 359.00, valorME_EPP: 179.50 },
            { min: 201, max: 300, valorIntegral: 448.75, valorME_EPP: 224.38 },
            { min: 301, max: 350, valorIntegral: 538.50, valorME_EPP: 269.25 },
            { min: 351, max: 400, valorIntegral: 628.25, valorME_EPP: 314.13 },
            { min: 401, max: 500, valorIntegral: 718.00, valorME_EPP: 359.00 },
            { min: 501, max: 600, valorIntegral: 807.75, valorME_EPP: 403.88 },
            { min: 601, max: 1000, valorIntegral: 897.50, valorME_EPP: 448.75 },
            { min: 1001, max: 1500, valorIntegral: 1077.00, valorME_EPP: 538.50 },
            { min: 1501, max: Infinity, valorIntegral: 1256.50, valorME_EPP: 628.25 }
        ];

        function App() {
            const [auth, setAuth] = useState(false);
            const [loading, setLoading] = useState(true);
            const [tab, setTab] = useState('doc');
            const [valorUfica, setValorUfica] = useState({ 2026: 179.50, 2027: 0, 2028: 0, 2029: 0, 2030: 0 });

            // Verificar estado de autentica√ß√£o ao carregar
            useEffect(() => {
                const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                    setAuth(!!user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                try {
                    await firebase.auth().signOut();
                    setAuth(false);
                } catch (error) {
                    console.error('Erro ao sair:', error);
                    alert('Erro ao fazer logout');
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700">
                    <div className="text-center">
                        <div className="animate-spin h-16 w-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p className="text-white text-lg">Carregando...</p>
                    </div>
                </div>
            );

            if (!auth) return <Login onLogin={() => setAuth(true)} />;

            return (
                <div>
                    <nav className="bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <h1 className="text-white font-bold text-xl">üèõÔ∏è Sistema Municipal</h1>
                            <div className="flex gap-4">
                                <button onClick={() => setTab('doc')} className={`px-4 py-2 rounded-lg font-medium ${tab === 'doc' ? 'bg-white text-blue-600' : 'text-white hover:bg-blue-500'}`}>üìÑ Documentos</button>
                                <button onClick={() => setTab('tax')} className={`px-4 py-2 rounded-lg font-medium ${tab === 'tax' ? 'bg-white text-blue-600' : 'text-white hover:bg-blue-500'}`}>üí∞ Contribuintes</button>
                                <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium">üö™ Sair</button>
                            </div>
                        </div>
                    </nav>
                    {tab === 'doc' ? <Docs /> : <Taxas valorUfica={valorUfica} setValorUfica={setValorUfica} />}
                    <footer className="bg-white border-t mt-8">
                        <div className="max-w-7xl mx-auto px-4 py-6 text-center">
                            <p className="text-gray-700 font-semibold mb-2">üíª Desenvolvido por <span className="text-blue-600">Elvis Ferreira</span></p>
                            <div className="flex flex-col sm:flex-row items-center justify-center gap-2 text-sm text-gray-600">
                                <a href="mailto:elvis.fdj@aol.com" className="hover:text-blue-600">üìß elvis.fdj@aol.com</a>
                                <span className="hidden sm:inline">‚Ä¢</span>
                                <a href="tel:+5522981382619" className="hover:text-blue-600">üì± (22) 98138-2619</a>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        function Login({ onLogin }) {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [e, setE] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (ev) => {
                ev.preventDefault();
                setLoading(true);
                setE('');

                try {
                    // Autentica√ß√£o real com Firebase
                    await firebase.auth().signInWithEmailAndPassword(u, p);
                    onLogin();
                } catch (error) {
                    console.error('Erro de autentica√ß√£o:', error);

                    // Mensagens de erro amig√°veis
                    if (error.code === 'auth/user-not-found') {
                        setE('‚ùå Usu√°rio n√£o encontrado');
                    } else if (error.code === 'auth/wrong-password') {
                        setE('‚ùå Senha incorreta');
                    } else if (error.code === 'auth/invalid-email') {
                        setE('‚ùå Email inv√°lido');
                    } else if (error.code === 'auth/too-many-requests') {
                        setE('‚ùå Muitas tentativas. Aguarde alguns minutos');
                    } else {
                        setE('‚ùå Erro ao fazer login. Verifique suas credenciais');
                    }

                    setP('');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen relative overflow-hidden flex items-center justify-center p-4">
                    {/* Background animado com gradiente */}
                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-700">
                        <div className="absolute inset-0 opacity-30">
                            <div className="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl animate-blob"></div>
                            <div className="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-2000"></div>
                            <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-4000"></div>
                        </div>
                    </div>

                    {/* Part√≠culas flutuantes */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 w-2 h-2 bg-white rounded-full opacity-20 animate-float"></div>
                        <div className="absolute top-1/3 right-1/4 w-3 h-3 bg-white rounded-full opacity-30 animate-float animation-delay-1000"></div>
                        <div className="absolute bottom-1/4 left-1/3 w-2 h-2 bg-white rounded-full opacity-25 animate-float animation-delay-2000"></div>
                        <div className="absolute top-2/3 right-1/3 w-2 h-2 bg-white rounded-full opacity-20 animate-float animation-delay-3000"></div>
                    </div>

                    {/* Card de Login com Glassmorphism */}
                    <div className="relative z-10 w-full max-w-md">
                        <div className="backdrop-blur-xl bg-white/90 rounded-3xl shadow-2xl p-10 border border-white/20 transform transition-all duration-300 hover:scale-[1.02]">
                            {/* Header com √≠cone animado */}
                            <div className="text-center mb-8">
                                <div className="relative inline-block mb-6">
                                    <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full blur-lg opacity-50 animate-pulse"></div>
                                    <div className="relative bg-gradient-to-br from-indigo-500 to-purple-600 w-24 h-24 rounded-full flex items-center justify-center shadow-lg transform transition-transform duration-300 hover:rotate-12">
                                        <span className="text-5xl animate-bounce-slow">üèõÔ∏è</span>
                                    </div>
                                </div>
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                                    Sistema Municipal
                                </h1>
                                <p className="text-gray-600 font-medium">Controle Geral e Gest√£o</p>
                                <div className="mt-4 flex items-center justify-center gap-2 text-sm text-gray-500">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span>Sistema Online</span>
                                </div>
                            </div>

                            {/* Formul√°rio */}
                            <form onSubmit={handleSubmit} className="space-y-5">
                                {/* Campo Email */}
                                <div className="group">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <span className="text-lg">üìß</span>
                                        Email
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="email"
                                            value={u}
                                            onChange={(ev) => setU(ev.target.value)}
                                            placeholder="seu.email@exemplo.com"
                                            className="w-full px-5 py-4 bg-white border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all duration-300 outline-none disabled:opacity-50 disabled:cursor-not-allowed group-hover:border-indigo-300"
                                            required
                                            disabled={loading}
                                        />
                                    </div>
                                </div>

                                {/* Campo Senha */}
                                <div className="group">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        <span className="text-lg">üîë</span>
                                        Senha
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="password"
                                            value={p}
                                            onChange={(ev) => setP(ev.target.value)}
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            className="w-full px-5 py-4 bg-white border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all duration-300 outline-none disabled:opacity-50 disabled:cursor-not-allowed group-hover:border-indigo-300"
                                            required
                                            disabled={loading}
                                        />
                                    </div>
                                </div>

                                {/* Mensagem de Erro */}
                                {e && (
                                    <div className="bg-red-50 border-2 border-red-200 text-red-700 px-5 py-4 rounded-xl text-sm font-medium flex items-center gap-3 animate-shake">
                                        <span className="text-xl">‚ö†Ô∏è</span>
                                        <span>{e}</span>
                                    </div>
                                )}

                                {/* Bot√£o de Login */}
                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 font-bold text-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 active:translate-y-0"
                                    disabled={loading}
                                >
                                    {loading ? (
                                        <>
                                            <svg className="animate-spin h-6 w-6" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span>Autenticando...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span className="text-2xl">üîì</span>
                                            <span>Entrar no Sistema</span>
                                        </>
                                    )}
                                </button>
                            </form>

                            {/* Footer */}
                            <div className="mt-8 pt-6 border-t border-gray-200">
                                <div className="flex items-center justify-center gap-2 text-xs text-gray-500">
                                    <span className="text-lg">üîí</span>
                                    <span className="font-medium">Protegido por Firebase Authentication</span>
                                </div>
                            </div>
                        </div>

                        {/* Elemento decorativo inferior */}
                        <div className="mt-6 text-center">
                            <p className="text-white/80 text-sm font-medium drop-shadow-lg">
                                üíª Desenvolvido por Elvis Ferreira
                            </p>
                        </div>
                    </div>

                    {/* Estilos de anima√ß√£o customizados */}
                    <style>{`
                        @keyframes blob {
                            0%, 100% { transform: translate(0, 0) scale(1); }
                            33% { transform: translate(30px, -50px) scale(1.1); }
                            66% { transform: translate(-20px, 20px) scale(0.9); }
                        }
                        @keyframes float {
                            0%, 100% { transform: translateY(0px); }
                            50% { transform: translateY(-20px); }
                        }
                        @keyframes bounce-slow {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-10px); }
                        }
                        @keyframes shake {
                            0%, 100% { transform: translateX(0); }
                            25% { transform: translateX(-5px); }
                            75% { transform: translateX(5px); }
                        }
                        .animate-blob {
                            animation: blob 7s infinite;
                        }
                        .animate-float {
                            animation: float 3s ease-in-out infinite;
                        }
                        .animate-bounce-slow {
                            animation: bounce-slow 2s ease-in-out infinite;
                        }
                        .animate-shake {
                            animation: shake 0.3s ease-in-out;
                        }
                        .animation-delay-1000 {
                            animation-delay: 1s;
                        }
                        .animation-delay-2000 {
                            animation-delay: 2s;
                        }
                        .animation-delay-3000 {
                            animation-delay: 3s;
                        }
                        .animation-delay-4000 {
                            animation-delay: 4s;
                        }
                    `}</style>
                </div>
            );
        }

        function Docs() {
            const [docs, setDocs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editando, setEditando] = useState(null);
            const [filtros, setFiltros] = useState({ tipo: 'TODOS', setor: '', dataInicio: '', dataFim: '' });
            const [form, setForm] = useState({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
            const year = new Date().getFullYear();

            useEffect(() => {
                const ref = db.ref('documentos/' + year);
                ref.on('value', (snap) => {
                    const data = snap.val();
                    setDocs(data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : []);
                    setLoading(false);
                });
                return () => ref.off();
            }, []);

            const add = async () => {
                if (!form.setorOrigem.trim()) return alert('Preencha o Setor de Origem');
                const num = docs.filter(d => d.tipo === form.tipo).length + 1;
                await db.ref('documentos/' + year).push({ ...form, numero: `${String(num).padStart(4, '0')}/${year}`, criadoEm: Date.now(), criadoPor: 'SAR' });
                setForm({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
                alert('‚úÖ Documento adicionado!');
            };

            const update = async (id) => {
                await db.ref('documentos/' + year + '/' + id).update({ ...editando, editadoEm: Date.now(), editadoPor: 'SAR' });
                setEditando(null);
                alert('‚úÖ Documento atualizado!');
            };

            const del = async (id) => {
                if (confirm('Excluir documento?')) {
                    await db.ref('documentos/' + year + '/' + id).remove();
                }
            };

            const formatDate = (dateStr) => {
                const [y, m, d] = dateStr.split('-');
                return new Date(y, m - 1, d).toLocaleDateString('pt-BR');
            };

            const exportCSV = () => {
                const headers = ['Tipo', 'N√∫mero', 'Data', 'Setor Origem', 'Setor Destino', 'Observa√ß√£o'];
                const rows = docsFiltrados.map(d => [d.tipo, d.numero, formatDate(d.data), d.setorOrigem, d.setorDestino || '', d.obs || '']);
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `documentos_${year}.csv`;
                link.click();
            };

            const docsFiltrados = docs.filter(d => {
                const tipoOk = filtros.tipo === 'TODOS' || d.tipo === filtros.tipo;
                const setorOk = !filtros.setor || d.setorOrigem.toLowerCase().includes(filtros.setor.toLowerCase()) || (d.setorDestino && d.setorDestino.toLowerCase().includes(filtros.setor.toLowerCase()));
                const dataOk = (!filtros.dataInicio || d.data >= filtros.dataInicio) && (!filtros.dataFim || d.data <= filtros.dataFim);
                return tipoOk && setorOk && dataOk;
            });

            const stats = {
                total: docsFiltrados.length,
                EDITAL: docsFiltrados.filter(d => d.tipo === 'EDITAL').length,
                OFICIO: docsFiltrados.filter(d => d.tipo === 'OFICIO').length,
                MEMORANDO: docsFiltrados.filter(d => d.tipo === 'MEMORANDO').length
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin h-16 w-16 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold">üìÑ Controle de Numera√ß√£o - {year}</h2>
                                <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üìä Exportar CSV</button>
                            </div>

                            <div className="grid md:grid-cols-4 gap-4 mb-6">
                                <select value={filtros.tipo} onChange={(e) => setFiltros({ ...filtros, tipo: e.target.value })} className="px-3 py-2 border rounded-lg">
                                    <option value="TODOS">Todos os Tipos</option>
                                    <option value="EDITAL">EDITAL</option>
                                    <option value="OFICIO">OF√çCIO</option>
                                    <option value="MEMORANDO">MEMORANDO</option>
                                </select>
                                <input type="text" value={filtros.setor} onChange={(e) => setFiltros({ ...filtros, setor: e.target.value })} placeholder="Buscar por setor..." className="px-3 py-2 border rounded-lg" />
                                <input type="date" value={filtros.dataInicio} onChange={(e) => setFiltros({ ...filtros, dataInicio: e.target.value })} className="px-3 py-2 border rounded-lg" />
                                <input type="date" value={filtros.dataFim} onChange={(e) => setFiltros({ ...filtros, dataFim: e.target.value })} className="px-3 py-2 border rounded-lg" />
                            </div>

                            <div className="grid md:grid-cols-4 gap-4">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                    <div className="text-sm text-blue-600 font-medium">Total</div>
                                    <div className="text-3xl font-bold text-blue-700">{stats.total}</div>
                                </div>
                                <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                    <div className="text-sm text-green-600 font-medium">EDITAL</div>
                                    <div className="text-3xl font-bold text-green-700">{stats.EDITAL}</div>
                                </div>
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                    <div className="text-sm text-purple-600 font-medium">OF√çCIO</div>
                                    <div className="text-3xl font-bold text-purple-700">{stats.OFICIO}</div>
                                </div>
                                <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                    <div className="text-sm text-orange-600 font-medium">MEMORANDO</div>
                                    <div className="text-3xl font-bold text-orange-700">{stats.MEMORANDO}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h3 className="text-xl font-bold mb-4">‚ûï Novo Documento</h3>
                            <div className="grid md:grid-cols-3 gap-4">
                                <select value={form.tipo} onChange={(e) => setForm({ ...form, tipo: e.target.value })} className="px-3 py-2 border rounded-lg">
                                    <option>EDITAL</option>
                                    <option>OFICIO</option>
                                    <option>MEMORANDO</option>
                                </select>
                                <input type="date" value={form.data} onChange={(e) => setForm({ ...form, data: e.target.value })} className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorOrigem} onChange={(e) => setForm({ ...form, setorOrigem: e.target.value })} placeholder="Setor Origem *" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorDestino} onChange={(e) => setForm({ ...form, setorDestino: e.target.value })} placeholder="Setor Destino" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.obs} onChange={(e) => setForm({ ...form, obs: e.target.value })} placeholder="Observa√ß√£o" className="px-3 py-2 border rounded-lg md:col-span-2" />
                            </div>
                            <button onClick={add} className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">‚ûï Adicionar</button>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left">Tipo</th>
                                            <th className="px-4 py-3 text-left">N√∫mero</th>
                                            <th className="px-4 py-3 text-left">Data</th>
                                            <th className="px-4 py-3 text-left">Origem</th>
                                            <th className="px-4 py-3 text-left">Destino</th>
                                            <th className="px-4 py-3 text-left">Observa√ß√£o</th>
                                            <th className="px-4 py-3 text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {docsFiltrados.length === 0 ? (
                                            <tr><td colSpan="7" className="px-4 py-8 text-center text-gray-500">Nenhum documento encontrado</td></tr>
                                        ) : (
                                            docsFiltrados.slice().reverse().map((d, i) => (
                                                <tr key={d.id} className={i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                                    {editando?.id === d.id ? (
                                                        <>
                                                            <td className="px-4 py-3"><select value={editando.tipo} onChange={(e) => setEditando({ ...editando, tipo: e.target.value })} className="px-2 py-1 border rounded w-full"><option>EDITAL</option><option>OFICIO</option><option>MEMORANDO</option></select></td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3"><input type="date" value={editando.data} onChange={(e) => setEditando({ ...editando, data: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorOrigem} onChange={(e) => setEditando({ ...editando, setorOrigem: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorDestino || ''} onChange={(e) => setEditando({ ...editando, setorDestino: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.obs || ''} onChange={(e) => setEditando({ ...editando, obs: e.target.value })} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => update(d.id)} className="text-green-600 hover:text-green-800 mr-2 text-xl">‚úì</button>
                                                                <button onClick={() => setEditando(null)} className="text-gray-600 hover:text-gray-800 text-xl">‚úó</button>
                                                            </td>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <td className="px-4 py-3 font-semibold text-blue-600">{d.tipo}</td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3">{formatDate(d.data)}</td>
                                                            <td className="px-4 py-3">{d.setorOrigem}</td>
                                                            <td className="px-4 py-3">{d.setorDestino || '-'}</td>
                                                            <td className="px-4 py-3 text-sm">{d.obs || '-'}</td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => setEditando(d)} className="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button>
                                                                <button onClick={() => del(d.id)} className="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                                                            </td>
                                                        </>
                                                    )}
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Taxas({ valorUfica, setValorUfica }) {
            const [list, setList] = useState([]);
            const [mes, setMes] = useState(new Date().getMonth());
            const [ano, setAno] = useState(new Date().getFullYear());
            const [consultandoQueue, setConsultandoQueue] = useState([]);
            const [consultasRealizadas, setConsultasRealizadas] = useState(0);
            const [ultimaConsulta, setUltimaConsulta] = useState(null);
            const [abaAtiva, setAbaAtiva] = useState('principal');
            const [modalInserir, setModalInserir] = useState(false);
            const [formInserir, setFormInserir] = useState({ inscricao: '', documento: '', nome: '' });
            const [modoVisualizacao, setModoVisualizacao] = useState('mensal');
            const [periodoInicio, setPeriodoInicio] = useState(0);
            const [periodoFim, setPeriodoFim] = useState(11);

            const valorUficaAtual = valorUfica[ano] || VALOR_UFICA_2026;

            // Carregar dados do Firebase filtrados por m√™s/ano
            useEffect(() => {
                const chave = `contribuintes/${ano}/${mes}`;
                const ref = db.ref(chave);
                ref.on('value', (snap) => {
                    const data = snap.val();
                    setList(data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : []);
                });
                return () => ref.off();
            }, [mes, ano]);

            const salvarNoFirebase = async (contribuinte) => {
                const chave = `contribuintes/${ano}/${mes}`;
                await db.ref(chave).push(contribuinte);
            };

            const consultarCNPJ = async (cnpj, id) => {
                try {
                    if (ultimaConsulta) {
                        const tempoDecorrido = Date.now() - ultimaConsulta.getTime();
                        if (tempoDecorrido < 12000) {
                            await new Promise(resolve => setTimeout(resolve, 12000 - tempoDecorrido));
                        }
                    }

                    const response = await fetch(`https://open.cnpja.com/office/${cnpj}`);
                    if (!response.ok) throw new Error('Erro na consulta');

                    const data = await response.json();

                    let porte = '';
                    if (data.company?.size?.acronym) {
                        porte = data.company.size.acronym;
                    } else if (data.company?.size?.text) {
                        const porteText = data.company.size.text.toUpperCase();
                        if (porteText.includes('MICRO')) porte = 'ME';
                        else if (porteText.includes('PEQUENO')) porte = 'EPP';
                        else porte = 'DEMAIS';
                    }

                    let tributacao = '';
                    if (data.company?.simei?.optant) {
                        tributacao = 'MEI';
                    } else if (porte === 'ME') {
                        tributacao = 'SIMPLES';
                    } else if (data.company?.simples?.optant && porte === 'EPP') {
                        tributacao = 'SIMPLES';
                    } else if (porte === 'EPP' && !data.company?.simples?.optant) {
                        tributacao = 'EPP';
                    } else {
                        tributacao = 'LUCRO PRESUMIDO';
                    }

                    let situacao = data.status?.text || '';

                    const cnaes = [];
                    if (data.mainActivity?.id) {
                        const cnaeStr = String(data.mainActivity.id);
                        cnaes.push(cnaeStr.substring(0, 4));
                    }
                    if (data.sideActivities) {
                        data.sideActivities.forEach(sec => {
                            if (sec.id) {
                                const cnaeStr = String(sec.id);
                                cnaes.push(cnaeStr.substring(0, 4));
                            }
                        });
                    }

                    const precisaVisa = cnaes.some(cnae => CNAES_VISA.includes(cnae));

                    const atualizado = { porte, tributacao, situacao, precisaVisa, verificado: true, dadosAPI: data };

                    setList(prevList => prevList.map(item =>
                        item.id === id ? { ...item, ...atualizado } : item
                    ));

                    // Atualizar no Firebase
                    await db.ref(`contribuintes/${ano}/${mes}/${id}`).update(atualizado);

                    setConsultasRealizadas(prev => prev + 1);
                    setUltimaConsulta(new Date());

                    return { success: true, porte, tributacao, situacao };
                } catch (error) {
                    console.error('Erro ao consultar CNPJ:', error);
                    return { success: false, error: error.message };
                }
            };

            const consultarTodos = async () => {
                const naoConsultados = list.filter(l => !l.verificado && l.tipoPessoa === 'CNPJ');

                if (naoConsultados.length === 0) {
                    alert('Todos os CNPJs j√° foram consultados!');
                    return;
                }

                setConsultandoQueue(naoConsultados.map(l => l.id));

                for (let i = 0; i < naoConsultados.length; i++) {
                    const item = naoConsultados[i];
                    await consultarCNPJ(item.documento, item.id);
                    if (i < naoConsultados.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 12000));
                    }
                }

                setConsultandoQueue([]);
                alert(`‚úÖ ${naoConsultados.length} CNPJs consultados!`);
            };

            const calcISSQN = (nivel, trimestre, isento, tipoPessoa) => {
                if (isento || tipoPessoa !== 'CPF' || nivel === 'VARIAVEL') return 0;
                const base = nivel === 'SUPERIOR' ? 8 : 5;
                const trimestres = 4 - (trimestre - 1);
                return (base / 4) * trimestres;
            };

            const calcVISA = (area, tributacao, porte, precisaVisa) => {
                if (tributacao === 'MEI' || tributacao === 'ISENTO' || !precisaVisa) return 0;
                if (!area || area === 0) return 0;

                const faixa = TABELA_VISA.find(f => area >= f.min && area <= f.max);
                if (!faixa) return 0;

                if (tributacao === 'SIMPLES') {
                    return faixa.valorME_EPP;
                }

                return faixa.valorIntegral;
            };

            const getPorteUFICAS = (tributacao, tipoPessoa) => {
                if (tributacao === 'MEI' || tributacao === 'ISENTO') return 0;

                const valores = {
                    'MEI': 0,
                    'SIMPLES': 2.5,
                    'EPP': 2.5,
                    'LUCRO PRESUMIDO': 8,
                    'LUCRO REAL': 20,
                    'AUTONOMO': 2.5,
                    'ISENTO': 0
                };

                if (tipoPessoa === 'CPF') return 2.5;

                return valores[tributacao] || 0;
            };

            const calcTFLFReais = (tributacao, tipoPessoa) => {
                const uficas = getPorteUFICAS(tributacao, tipoPessoa);
                return uficas * valorUficaAtual;
            };

            const calcDashboard = () => {
                let listaCalculo = list;

                // Aplicar filtro de visualiza√ß√£o
                if (modoVisualizacao === 'anual') {
                    // Carregar todos os meses do ano
                    // Por simplicidade, vamos usar apenas a lista atual
                    listaCalculo = list;
                } else if (modoVisualizacao === 'periodo') {
                    // Filtrar por per√≠odo
                    listaCalculo = list;
                }

                const total = listaCalculo.length;
                const pendentes = listaCalculo.filter(l => l.taxasLancadas === 'NAO').length;
                const verificados = listaCalculo.filter(l => l.verificado).length;

                const documentos = {};
                const duplicados = [];
                listaCalculo.forEach(l => {
                    if (documentos[l.documento]) {
                        duplicados.push(l.documento);
                    }
                    documentos[l.documento] = (documentos[l.documento] || 0) + 1;
                });
                const totalDuplicados = new Set(duplicados).size;

                let totalUFICAS = 0;
                let totalReais = 0;
                let totalISSQN = 0;

                listaCalculo.forEach(l => {
                    const uficas = getPorteUFICAS(l.tributacao, l.tipoPessoa);
                    const reais = uficas * valorUficaAtual;
                    const issqn = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);

                    totalUFICAS += uficas;
                    totalReais += reais;
                    totalISSQN += issqn * valorUficaAtual;
                });

                const vigilancia = listaCalculo.reduce((sum, l) => sum + calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa), 0);

                return { total, pendentes, verificados, totalUFICAS, totalReais, vigilancia, totalDuplicados, totalISSQN };
            };

            const formatarMoeda = (valor) => {
                return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            const inserirManual = async () => {
                if (!formInserir.documento.trim() || !formInserir.nome.trim()) {
                    alert('Preencha pelo menos Documento e Nome!');
                    return;
                }

                const clean = formInserir.documento.replace(/\D/g, '');
                const novo = {
                    inscricaoMunicipal: formInserir.inscricao || '',
                    documento: clean,
                    tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                    razaoSocial: formInserir.nome,
                    porte: '',
                    tributacao: clean.length === 11 ? 'AUTONOMO' : '',
                    situacao: '',
                    areaM2: 0,
                    ordemServico: '',
                    nivelISSQN: clean.length === 11 ? 'MEDIO' : 'VARIAVEL',
                    issqnIsento: false,
                    trimestreAbertura: 1,
                    taxasLancadas: 'NAO',
                    verificado: false,
                    precisaVisa: false,
                    criadoEm: Date.now()
                };

                await salvarNoFirebase(novo);
                setFormInserir({ inscricao: '', documento: '', nome: '' });
                setModalInserir(false);
                alert('‚úÖ Contribuinte adicionado!');
            };

            const importarTXT = (file) => {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const linhas = e.target.result.split('\n');
                    let novos = 0;
                    let ignorados = 0;

                    // Obter documentos j√° verificados
                    const docsVerificados = new Set(list.filter(l => l.verificado).map(l => l.documento));

                    for (const l of linhas) {
                        if (!l.trim()) continue;

                        const partes = l.split('\t').map(p => p.trim());
                        const [insc, doc, nome] = partes;

                        if (!doc) continue;

                        const clean = doc.replace(/\D/g, '');

                        // Ignorar se j√° foi verificado
                        if (docsVerificados.has(clean)) {
                            ignorados++;
                            continue;
                        }

                        const contribuinte = {
                            inscricaoMunicipal: insc || '',
                            documento: clean,
                            tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                            razaoSocial: nome || '',
                            porte: '',
                            areaM2: 0,
                            nivelISSQN: 'MEDIO',
                            issqnIsento: false,
                            trimestreAbertura: 1,
                            taxasLancadas: 'NAO',
                            verificado: false,
                            criadoEm: Date.now()
                        };

                        await salvarNoFirebase(contribuinte);
                        novos++;
                    }

                    alert(`‚úÖ ${novos} contribuintes importados!\n‚è≠Ô∏è ${ignorados} j√° verificados foram ignorados.`);
                };

                reader.readAsText(file);
            };

            const exportCSV = () => {
                const header = ['Inscri√ß√£o', 'Documento', 'Nome', 'Porte', 'Tributa√ß√£o', 'N¬∞ OS', 'Auditor', 'TFLF (R$)', 'ISSQN (R$)', 'VISA (R$)', 'Verificado', 'Taxas Lan√ßadas'];
                const rows = list.map(l => {
                    const tflf = calcTFLFReais(l.tributacao, l.tipoPessoa);
                    const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                    const issqnReais = issqnUficas * valorUficaAtual;
                    const visa = calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa);

                    return [
                        l.inscricaoMunicipal,
                        l.documento,
                        l.razaoSocial,
                        l.porte || '',
                        l.tributacao || '',
                        l.ordemServico || '',
                        l.auditor || '',
                        tflf.toFixed(2),
                        issqnReais.toFixed(2),
                        visa.toFixed(2),
                        l.verificado ? 'SIM' : 'NAO',
                        l.taxasLancadas
                    ];
                });

                const csv = [header, ...rows].map(r => r.join(';')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `taxas_${MESES[mes]}_${ano}.csv`;
                a.click();
            };

            const update = async (id, campo, valor) => {
                setList(list.map(item =>
                    item.id === id ? { ...item, [campo]: valor } : item
                ));
                await db.ref(`contribuintes/${ano}/${mes}/${id}`).update({ [campo]: valor });
            };

            const excluir = async (id) => {
                if (confirm('Tem certeza que deseja excluir?')) {
                    await db.ref(`contribuintes/${ano}/${mes}/${id}`).remove();
                }
            };

            const getDuplicados = () => {
                const documentos = {};
                list.forEach(l => {
                    if (!documentos[l.documento]) {
                        documentos[l.documento] = [];
                    }
                    documentos[l.documento].push(l);
                });

                return Object.values(documentos).filter(grupo => grupo.length > 1).flat();
            };

            const dashboard = calcDashboard();

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="mb-6">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="text-3xl">üí∞</span>
                            <h2 className="text-2xl font-bold">Lan√ßamento de Taxas</h2>
                        </div>

                        <div className="flex gap-4 mb-4 flex-wrap">
                            <select value={modoVisualizacao} onChange={e => setModoVisualizacao(e.target.value)} className="px-4 py-2 border rounded bg-white">
                                <option value="mensal">üìÖ Mensal</option>
                                <option value="anual">üìä Consolidado Anual</option>
                                <option value="periodo">üìÜ Por Per√≠odo</option>
                            </select>

                            {modoVisualizacao === 'mensal' && (
                                <>
                                    <select value={mes} onChange={e => setMes(Number(e.target.value))} className="px-4 py-2 border rounded bg-white">
                                        {MESES.map((m, i) => (
                                            <option key={i} value={i}>{m}</option>
                                        ))}
                                    </select>
                                </>
                            )}

                            {modoVisualizacao === 'periodo' && (
                                <>
                                    <select value={periodoInicio} onChange={e => setPeriodoInicio(Number(e.target.value))} className="px-4 py-2 border rounded bg-white">
                                        {MESES.map((m, i) => (
                                            <option key={i} value={i}>{m}</option>
                                        ))}
                                    </select>
                                    <span className="flex items-center">at√©</span>
                                    <select value={periodoFim} onChange={e => setPeriodoFim(Number(e.target.value))} className="px-4 py-2 border rounded bg-white">
                                        {MESES.map((m, i) => (
                                            <option key={i} value={i}>{m}</option>
                                        ))}
                                    </select>
                                </>
                            )}

                            <select value={ano} onChange={e => setAno(Number(e.target.value))} className="px-4 py-2 border rounded bg-white">
                                {[2026, 2027, 2028, 2029, 2030].map(a => (
                                    <option key={a} value={a}>{a}</option>
                                ))}
                            </select>

                            <div className="px-4 py-2 bg-blue-50 text-blue-700 rounded border border-blue-200">
                                {modoVisualizacao === 'mensal' && `üìÖ ${MESES[mes]}/${ano}`}
                                {modoVisualizacao === 'anual' && `üìä Ano ${ano}`}
                                {modoVisualizacao === 'periodo' && `üìÜ ${MESES[periodoInicio]} - ${MESES[periodoFim]}/${ano}`}
                            </div>

                            {ano >= 2027 ? (
                                <div className="flex items-center gap-2 bg-green-50 border border-green-200 rounded px-3 py-2">
                                    <label className="text-sm text-green-700 font-medium">üíµ UFICA {ano}:</label>
                                    <input type="number" step="0.01" value={valorUfica[ano] || ''} onChange={e => setValorUfica({ ...valorUfica, [ano]: parseFloat(e.target.value) || 0 })} className="px-3 py-1 border rounded w-32 text-sm" placeholder="0.00" />
                                </div>
                            ) : (
                                <div className="px-4 py-2 bg-green-50 text-green-700 rounded border border-green-200 text-sm">
                                    üíµ UFICA {ano}: R$ {formatarMoeda(valorUficaAtual)}
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-7 gap-4 mb-6">
                            <div className="bg-white rounded-lg p-4 border">
                                <div className="text-sm text-gray-600 mb-1">Total</div>
                                <div className="text-3xl font-bold text-gray-800">{dashboard.total}</div>
                            </div>

                            <div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                <div className="text-sm text-gray-600 mb-1">Pendentes</div>
                                <div className="text-3xl font-bold text-yellow-600">{dashboard.pendentes}</div>
                            </div>

                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                <div className="text-sm text-gray-600 mb-1">‚úÖ Verificados</div>
                                <div className="text-3xl font-bold text-green-600">{dashboard.verificados}</div>
                            </div>

                            <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                <div className="text-sm text-gray-600 mb-1">‚ö†Ô∏è Duplicados</div>
                                <div className="text-3xl font-bold text-orange-600">{dashboard.totalDuplicados}</div>
                            </div>

                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <div className="text-sm text-gray-600 mb-1">Total TFLF</div>
                                <div className="text-3xl font-bold text-blue-600">R$ {formatarMoeda(dashboard.totalReais)}</div>
                            </div>

                            <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                                <div className="text-sm text-gray-600 mb-1">Total ISSQN</div>
                                <div className="text-3xl font-bold text-indigo-600">R$ {formatarMoeda(dashboard.totalISSQN)}</div>
                            </div>

                            <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                <div className="text-sm text-gray-600 mb-1">Vigil√¢ncia</div>
                                <div className="text-3xl font-bold text-purple-600">R$ {formatarMoeda(dashboard.vigilancia)}</div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                            <div className="flex gap-2 mb-4 border-b">
                                <button onClick={() => setAbaAtiva('principal')} className={`px-4 py-2 font-medium ${abaAtiva === 'principal' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'}`}>
                                    üìã Principal ({list.length})
                                </button>
                                <button onClick={() => setAbaAtiva('duplicados')} className={`px-4 py-2 font-medium ${abaAtiva === 'duplicados' ? 'text-orange-600 border-b-2 border-orange-600' : 'text-gray-600'}`}>
                                    ‚ö†Ô∏è Duplicidade ({dashboard.totalDuplicados})
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-4">
                                <button onClick={() => setModalInserir(true)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    ‚ûï Inserir
                                </button>

                                <label className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded cursor-pointer hover:bg-indigo-700">
                                    <span>üìÅ Importar TXT</span>
                                    <input type="file" accept=".txt" onChange={e => importarTXT(e.target.files[0])} className="hidden" />
                                </label>

                                <button onClick={consultarTodos} className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700" disabled={consultandoQueue.length > 0}>
                                    {consultandoQueue.length > 0 ? 'üîÑ Consultando...' : 'üîç Consultar CNPJs'}
                                </button>

                                <button onClick={exportCSV} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    üìä Exportar CSV
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            {modalInserir && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                        <h3 className="text-xl font-bold mb-4">‚ûï Inserir Contribuinte</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Inscri√ß√£o Municipal</label>
                                                <input type="text" value={formInserir.inscricao} onChange={e => setFormInserir({ ...formInserir, inscricao: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Opcional" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">CPF/CNPJ *</label>
                                                <input type="text" value={formInserir.documento} onChange={e => setFormInserir({ ...formInserir, documento: e.target.value })} className="w-full px-3 py-2 border rounded" required />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nome/Raz√£o Social *</label>
                                                <input type="text" value={formInserir.nome} onChange={e => setFormInserir({ ...formInserir, nome: e.target.value })} className="w-full px-3 py-2 border rounded" required />
                                            </div>
                                        </div>
                                        <div className="flex gap-2 mt-6">
                                            <button onClick={inserirManual} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‚úì Confirmar</button>
                                            <button onClick={() => { setModalInserir(false); setFormInserir({ inscricao: '', documento: '', nome: '' }); }} className="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‚úó Cancelar</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-indigo-600 text-white">
                                        <tr>
                                            <th className="px-3 py-2 text-left">Status</th>
                                            <th className="px-3 py-2 text-left">Inscri√ß√£o</th>
                                            <th className="px-3 py-2 text-left">Documento</th>
                                            <th className="px-3 py-2 text-left">Nome</th>
                                            <th className="px-3 py-2">Situa√ß√£o</th>
                                            <th className="px-3 py-2">Porte</th>
                                            <th className="px-3 py-2">Tributa√ß√£o</th>
                                            <th className="px-3 py-2">VISA?</th>
                                            <th className="px-3 py-2">√Årea</th>
                                            <th className="px-3 py-2">N¬∞ OS</th>
                                            <th className="px-3 py-2">Auditor</th>
                                            <th className="px-3 py-2">Trimestre</th>
                                            <th className="px-3 py-2">N√≠vel</th>
                                            <th className="px-3 py-2">TFLF</th>
                                            <th className="px-3 py-2">ISSQN</th>
                                            <th className="px-3 py-2">VISA</th>
                                            <th className="px-3 py-2">Lan√ßado</th>
                                            <th className="px-3 py-2">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(() => {
                                            const listaExibir = abaAtiva === 'duplicados' ? getDuplicados() : list;

                                            if (listaExibir.length === 0) {
                                                return (
                                                    <tr>
                                                        <td colSpan="18" className="px-4 py-8 text-center text-gray-500">
                                                            {abaAtiva === 'duplicados' ? '‚úÖ Nenhum duplicado!' : 'Nenhum contribuinte. Importe um TXT.'}
                                                        </td>
                                                    </tr>
                                                );
                                            }

                                            return listaExibir.map(l => {
                                                const tflf = calcTFLFReais(l.tributacao, l.tipoPessoa);
                                                const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                                                const issqnReais = issqnUficas * valorUficaAtual;
                                                const visa = calcVISA(l.areaM2 || 0, l.tributacao, l.porte, l.precisaVisa);
                                                const consultando = consultandoQueue.includes(l.id);
                                                const isDuplicado = getDuplicados().some(d => d.id === l.id);

                                                return (
                                                    <tr key={l.id} className={`border-t hover:bg-gray-50 ${isDuplicado && abaAtiva === 'duplicados' ? 'bg-orange-50' : ''}`}>
                                                        <td className="px-3 py-2 text-center">
                                                            {consultando ? <span className="text-blue-600">üîÑ</span> : l.verificado ? <span className="text-green-600">‚úÖ</span> : isDuplicado ? <span className="text-orange-600">‚ö†Ô∏è</span> : <span className="text-gray-400">‚è≥</span>}
                                                        </td>
                                                        <td className="px-3 py-2">{l.inscricaoMunicipal}</td>
                                                        <td className="px-3 py-2 font-mono">{l.documento}</td>
                                                        <td className="px-3 py-2">{l.razaoSocial}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${l.situacao === 'Ativa' ? 'bg-green-100 text-green-800 border border-green-300' :
                                                                l.situacao === 'Suspensa' ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' :
                                                                    l.situacao === 'Inapta' ? 'bg-orange-100 text-orange-800 border border-orange-300' :
                                                                        l.situacao === 'Baixada' ? 'bg-red-100 text-red-800 border border-red-300' :
                                                                            l.situacao === 'Nula' ? 'bg-purple-100 text-purple-800 border border-purple-300' :
                                                                                'bg-gray-100 text-gray-700 border border-gray-300'
                                                                }`}>
                                                                {l.situacao || '-'}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.porte || ''} onChange={e => update(l.id, 'porte', e.target.value)} className="px-2 py-1 border rounded bg-white text-xs" disabled={l.tipoPessoa === 'CPF'}>
                                                                <option value="">-</option>
                                                                <option value="MEI">MEI</option>
                                                                <option value="ME">ME</option>
                                                                <option value="EPP">EPP</option>
                                                                <option value="DEMAIS">DEMAIS</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.tributacao || ''} onChange={e => update(l.id, 'tributacao', e.target.value)} className="px-2 py-1 border rounded bg-white text-xs">
                                                                <option value="">Selecione</option>
                                                                <option value="SIMPLES">Simples</option>
                                                                <option value="EPP">EPP</option>
                                                                <option value="LUCRO PRESUMIDO">L. Presumido</option>
                                                                <option value="LUCRO REAL">L. Real</option>
                                                                <option value="AUTONOMO">Aut√¥nomo</option>
                                                                <option value="ISENTO">Isento</option>
                                                                <option value="MEI">MEI</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <input type="checkbox" checked={l.precisaVisa || false} onChange={e => update(l.id, 'precisaVisa', e.target.checked)} className="w-4 h-4" />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <input type="number" value={l.areaM2 || ''} onChange={e => update(l.id, 'areaM2', Number(e.target.value))} className="px-2 py-1 border rounded w-16 text-xs" disabled={!l.precisaVisa} />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <input type="text" value={l.ordemServico || ''} onChange={e => update(l.id, 'ordemServico', e.target.value)} placeholder="N¬∞ OS" className="px-2 py-1 border rounded w-20 text-xs" />
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.auditor || ''} onChange={e => update(l.id, 'auditor', e.target.value)} className="px-2 py-1 border rounded text-xs bg-white">
                                                                <option value="">Selecione</option>
                                                                {AUDITORES.map((aud, idx) => <option key={idx} value={aud}>{aud}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.trimestreAbertura || 1} onChange={e => update(l.id, 'trimestreAbertura', Number(e.target.value))} className="px-2 py-1 border rounded text-xs bg-white">
                                                                <option value={1}>1¬∞</option>
                                                                <option value={2}>2¬∞</option>
                                                                <option value={3}>3¬∞</option>
                                                                <option value={4}>4¬∞</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.nivelISSQN} onChange={e => update(l.id, 'nivelISSQN', e.target.value)} className="px-2 py-1 border rounded text-xs" disabled={l.tipoPessoa === 'CNPJ'}>
                                                                {l.tipoPessoa === 'CNPJ' ? <option value="VARIAVEL">Vari√°vel</option> : <><option value="MEDIO">M√©dio</option><option value="SUPERIOR">Superior</option></>}
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(tflf)}</td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(issqnReais)}</td>
                                                        <td className="px-3 py-2 text-right">R$ {formatarMoeda(visa)}</td>
                                                        <td className="px-3 py-2">
                                                            <select value={l.taxasLancadas} onChange={e => update(l.id, 'taxasLancadas', e.target.value)} className={`px-2 py-1 border rounded text-xs ${l.taxasLancadas === 'SIM' ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'}`}>
                                                                <option value="NAO">N√ÉO</option>
                                                                <option value="SIM">SIM</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <button onClick={() => excluir(l.id)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs mr-1">üóëÔ∏è</button>
                                                            {l.tipoPessoa === 'CNPJ' && !l.verificado && <button onClick={() => consultarCNPJ(l.documento, l.id)} className="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">üîç</button>}
                                                        </td>
                                                    </tr>
                                                );
                                            });
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>
