<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Municipal - Controle Geral</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAajyRVH8eR7gWDAF-cE7Y32sKCyH3my8I",
            authDomain: "controle-numeros.firebaseapp.com",
            databaseURL: "https://controle-numeros-default-rtdb.firebaseio.com/",
            projectId: "controle-numeros",
            storageBucket: "controle-numeros.firebasestorage.app",
            messagingSenderId: "95868423352",
            appId: "1:95868423352:web:7968f64d68fc18eb8cb84d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ALIQUOTAS_ISSQN = { MEI: 0, ME: 2.5, EPP: 2.5, LUCRO_PRESUMIDO: 8, LUCRO_REAL: 20 };
        const ALIQUOTAS_CPF = { NIVEL_MEDIO: 5, NIVEL_SUPERIOR: 8, ISENTO: 0 };
        const TFLF_CPF = 2.5;

        const TABELA_VISA = [
            { min: 0, max: 50, ME_EPP: 100, outros: 150 },
            { min: 51, max: 100, ME_EPP: 150, outros: 200 },
            { min: 101, max: 200, ME_EPP: 200, outros: 300 },
            { min: 201, max: 500, ME_EPP: 300, outros: 450 },
            { min: 501, max: 1000, ME_EPP: 450, outros: 600 },
            { min: 1001, max: Infinity, ME_EPP: 600, outros: 900 }
        ];

        const CNAES_VISA = [
            '4711', '4712', '4721', '4722', '4723', '4724', '4729', // Com√©rcio varejista
            '5611', '5612', '5620', // Alimenta√ß√£o
            '8610', '8621', '8622', '8630', '8640', '8650', // Sa√∫de
            '1011', '1012', '1013', '1020', '1031', '1032', '1033', // Fabrica√ß√£o de alimentos
            '4631', '4632', '4633', '4634', '4635', '4636', '4637', '4639', // Com√©rcio atacadista de alimentos
            '1051', '1052', '1053', '1061', '1062', '1063', '1064', '1065', '1066', '1069', '1071', '1072', // Latic√≠nios e moagem
            '4781', '4782', '4783', '4784', '4785', '4789', // Com√©rcio ambulante
            '8711', '8712', '8720', '8730', '8800', // Assist√™ncia social
            '4771', '4772', '4773', '4774', '4781' // Farm√°cias e produtos m√©dicos
        ];
        const MESES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const VALOR_UFICA_2026 = 179.50;

        function App() {
            const [auth, setAuth] = useState(false);
            const [tab, setTab] = useState('doc');

            if (!auth) return <Login onLogin={() => setAuth(true)} />;

            return (
                <div>
                    <nav className="bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <h1 className="text-white font-bold text-xl">üèõÔ∏è Sistema Municipal - Controle Geral</h1>
                            <div className="flex gap-4">
                                <button onClick={() => setTab('doc')} className={`px-4 py-2 rounded-lg font-medium transition ${tab==='doc'?'bg-white text-blue-600':'text-white hover:bg-blue-500'}`}>üìÑ Documentos</button>
                                <button onClick={() => setTab('tax')} className={`px-4 py-2 rounded-lg font-medium transition ${tab==='tax'?'bg-white text-blue-600':'text-white hover:bg-blue-500'}`}>üí∞ Contribuintes</button>
                                <button onClick={() => setAuth(false)} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium">üö™ Sair</button>
                            </div>
                        </div>
                    </nav>
                    {tab === 'doc' ? <Docs /> : <Taxas />}
                    <footer className="bg-white border-t mt-8">
                        <div className="max-w-7xl mx-auto px-4 py-6 text-center">
                            <p className="text-gray-700 font-semibold mb-2">üíª Desenvolvido por <span className="text-blue-600">Elvis Ferreira</span></p>
                            <div className="flex flex-col sm:flex-row items-center justify-center gap-2 text-sm text-gray-600">
                                <a href="mailto:elvis.fdj@aol.com" className="hover:text-blue-600">üìß elvis.fdj@aol.com</a>
                                <span className="hidden sm:inline">‚Ä¢</span>
                                <a href="tel:+5522981382619" className="hover:text-blue-600">üì± (22) 98138-2619</a>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        function Login({ onLogin }) {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [e, setE] = useState('');

            const handleSubmit = (ev) => {
                ev.preventDefault();
                if (u === 'SAR' && p === 'PMCG2026') {
                    onLogin();
                } else {
                    setE('‚ùå Credenciais inv√°lidas');
                    setP('');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="text-4xl">üîê</span>
                            </div>
                            <h1 className="text-3xl font-bold mb-2">Sistema Municipal</h1>
                            <p className="text-gray-600">Controle Geral</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" value={u} onChange={(ev) => setU(ev.target.value)} placeholder="Usu√°rio" className="w-full px-4 py-3 border rounded-lg" required />
                            <input type="password" value={p} onChange={(ev) => setP(ev.target.value)} placeholder="Senha" className="w-full px-4 py-3 border rounded-lg" required />
                            {e && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">{e}</div>}
                            <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-semibold">üîì Entrar</button>
                        </form>
                    </div>
                </div>
            );
        }

        function Docs() {
            const [docs, setDocs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editando, setEditando] = useState(null);
            const [filtros, setFiltros] = useState({ tipo: 'TODOS', setor: '', dataInicio: '', dataFim: '' });
            const [form, setForm] = useState({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
            const year = new Date().getFullYear();

            useEffect(() => {
                const ref = db.ref('documentos/' + year);
                ref.on('value', (snap) => {
                    const data = snap.val();
                    setDocs(data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : []);
                    setLoading(false);
                });
                return () => ref.off();
            }, []);

            const add = async () => {
                if (!form.setorOrigem.trim()) return alert('Preencha o Setor de Origem');
                const num = docs.filter(d => d.tipo === form.tipo).length + 1;
                await db.ref('documentos/' + year).push({ 
                    ...form, 
                    numero: `${String(num).padStart(4, '0')}/${year}`, 
                    criadoEm: Date.now(),
                    criadoPor: 'SAR'
                });
                setForm({ tipo: 'EDITAL', data: new Date().toISOString().split('T')[0], setorOrigem: '', setorDestino: '', obs: '' });
                alert('‚úÖ Documento adicionado!');
            };

            const update = async (id) => {
                await db.ref('documentos/' + year + '/' + id).update({
                    ...editando,
                    editadoEm: Date.now(),
                    editadoPor: 'SAR'
                });
                setEditando(null);
                alert('‚úÖ Documento atualizado!');
            };

            const del = async (id) => {
                if (confirm('Excluir documento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    await db.ref('documentos/' + year + '/' + id).remove();
                }
            };

            const formatDate = (dateStr) => {
                const [y, m, d] = dateStr.split('-');
                return new Date(y, m - 1, d).toLocaleDateString('pt-BR');
            };

            const exportCSV = () => {
                const headers = ['Tipo', 'N√∫mero', 'Data', 'Setor Origem', 'Setor Destino', 'Observa√ß√£o'];
                const rows = docsFiltrados.map(d => [d.tipo, d.numero, formatDate(d.data), d.setorOrigem, d.setorDestino || '', d.obs || '']);
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `documentos_${year}.csv`;
                link.click();
            };

            const docsFiltrados = docs.filter(d => {
                const tipoOk = filtros.tipo === 'TODOS' || d.tipo === filtros.tipo;
                const setorOk = !filtros.setor || d.setorOrigem.toLowerCase().includes(filtros.setor.toLowerCase()) || (d.setorDestino && d.setorDestino.toLowerCase().includes(filtros.setor.toLowerCase()));
                const dataOk = (!filtros.dataInicio || d.data >= filtros.dataInicio) && (!filtros.dataFim || d.data <= filtros.dataFim);
                return tipoOk && setorOk && dataOk;
            });

            const stats = {
                total: docsFiltrados.length,
                EDITAL: docsFiltrados.filter(d => d.tipo === 'EDITAL').length,
                OFICIO: docsFiltrados.filter(d => d.tipo === 'OFICIO').length,
                MEMORANDO: docsFiltrados.filter(d => d.tipo === 'MEMORANDO').length
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin h-16 w-16 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold text-gray-800">üìÑ Controle de Numera√ß√£o - {year}</h2>
                                <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    Exportar CSV
                                </button>
                            </div>

                            <div className="grid md:grid-cols-4 gap-4 mb-6">
                                <select value={filtros.tipo} onChange={(e) => setFiltros({...filtros, tipo: e.target.value})} className="px-3 py-2 border rounded-lg">
                                    <option value="TODOS">Todos os Tipos</option>
                                    <option value="EDITAL">EDITAL</option>
                                    <option value="OFICIO">OF√çCIO</option>
                                    <option value="MEMORANDO">MEMORANDO</option>
                                </select>
                                <input type="text" value={filtros.setor} onChange={(e) => setFiltros({...filtros, setor: e.target.value})} placeholder="Buscar por setor..." className="px-3 py-2 border rounded-lg" />
                                <input type="date" value={filtros.dataInicio} onChange={(e) => setFiltros({...filtros, dataInicio: e.target.value})} className="px-3 py-2 border rounded-lg" placeholder="Data in√≠cio" />
                                <input type="date" value={filtros.dataFim} onChange={(e) => setFiltros({...filtros, dataFim: e.target.value})} className="px-3 py-2 border rounded-lg" placeholder="Data fim" />
                            </div>

                            <div className="grid md:grid-cols-4 gap-4">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                    <div className="text-sm text-blue-600 font-medium">Total</div>
                                    <div className="text-3xl font-bold text-blue-700">{stats.total}</div>
                                </div>
                                <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                    <div className="text-sm text-green-600 font-medium">EDITAL</div>
                                    <div className="text-3xl font-bold text-green-700">{stats.EDITAL}</div>
                                </div>
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                    <div className="text-sm text-purple-600 font-medium">OF√çCIO</div>
                                    <div className="text-3xl font-bold text-purple-700">{stats.OFICIO}</div>
                                </div>
                                <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                    <div className="text-sm text-orange-600 font-medium">MEMORANDO</div>
                                    <div className="text-3xl font-bold text-orange-700">{stats.MEMORANDO}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h3 className="text-xl font-bold mb-4">‚ûï Novo Documento</h3>
                            <div className="grid md:grid-cols-3 gap-4">
                                <select value={form.tipo} onChange={(e) => setForm({...form, tipo: e.target.value})} className="px-3 py-2 border rounded-lg">
                                    <option>EDITAL</option>
                                    <option>OFICIO</option>
                                    <option>MEMORANDO</option>
                                </select>
                                <input type="date" value={form.data} onChange={(e) => setForm({...form, data: e.target.value})} className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorOrigem} onChange={(e) => setForm({...form, setorOrigem: e.target.value})} placeholder="Setor Origem *" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.setorDestino} onChange={(e) => setForm({...form, setorDestino: e.target.value})} placeholder="Setor Destino" className="px-3 py-2 border rounded-lg" />
                                <input type="text" value={form.obs} onChange={(e) => setForm({...form, obs: e.target.value})} placeholder="Observa√ß√£o" className="px-3 py-2 border rounded-lg md:col-span-2" />
                            </div>
                            <button onClick={add} className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium">‚ûï Adicionar Documento</button>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left">Tipo</th>
                                            <th className="px-4 py-3 text-left">N√∫mero</th>
                                            <th className="px-4 py-3 text-left">Data</th>
                                            <th className="px-4 py-3 text-left">Origem</th>
                                            <th className="px-4 py-3 text-left">Destino</th>
                                            <th className="px-4 py-3 text-left">Observa√ß√£o</th>
                                            <th className="px-4 py-3 text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {docsFiltrados.length === 0 ? (
                                            <tr><td colSpan="7" className="px-4 py-8 text-center text-gray-500">Nenhum documento encontrado</td></tr>
                                        ) : (
                                            docsFiltrados.slice().reverse().map((d, i) => (
                                                <tr key={d.id} className={i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                                    {editando?.id === d.id ? (
                                                        <>
                                                            <td className="px-4 py-3"><select value={editando.tipo} onChange={(e) => setEditando({...editando, tipo: e.target.value})} className="px-2 py-1 border rounded w-full"><option>EDITAL</option><option>OFICIO</option><option>MEMORANDO</option></select></td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3"><input type="date" value={editando.data} onChange={(e) => setEditando({...editando, data: e.target.value})} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorOrigem} onChange={(e) => setEditando({...editando, setorOrigem: e.target.value})} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.setorDestino || ''} onChange={(e) => setEditando({...editando, setorDestino: e.target.value})} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3"><input type="text" value={editando.obs || ''} onChange={(e) => setEditando({...editando, obs: e.target.value})} className="px-2 py-1 border rounded w-full" /></td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => update(d.id)} className="text-green-600 hover:text-green-800 mr-2 text-xl" title="Salvar">‚úì</button>
                                                                <button onClick={() => setEditando(null)} className="text-gray-600 hover:text-gray-800 text-xl" title="Cancelar">‚úó</button>
                                                            </td>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <td className="px-4 py-3 font-semibold text-blue-600">{d.tipo}</td>
                                                            <td className="px-4 py-3 font-mono">{d.numero}</td>
                                                            <td className="px-4 py-3">{formatDate(d.data)}</td>
                                                            <td className="px-4 py-3">{d.setorOrigem}</td>
                                                            <td className="px-4 py-3">{d.setorDestino || '-'}</td>
                                                            <td className="px-4 py-3 text-sm">{d.obs || '-'}</td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button onClick={() => setEditando(d)} className="text-blue-600 hover:text-blue-800 mr-2" title="Editar">‚úèÔ∏è</button>
                                                                <button onClick={() => del(d.id)} className="text-red-600 hover:text-red-800" title="Excluir">üóëÔ∏è</button>
                                                            </td>
                                                        </>
                                                    )}
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Taxas() {
            const [list, setList] = useState([]);
            const [mes, setMes] = useState(new Date().getMonth());
            const [ano, setAno] = useState(new Date().getFullYear());
            const [consultandoQueue, setConsultandoQueue] = useState([]);
            const [consultasRealizadas, setConsultasRealizadas] = useState(0);
            const [ultimaConsulta, setUltimaConsulta] = useState(null);
            const [abaAtiva, setAbaAtiva] = useState('principal');

            useEffect(() => {
                const dadosExemplo = [
                    {
                        id: '1',
                        inscricaoMunicipal: '154610',
                        documento: '64204564000129',
                        tipoPessoa: 'CNPJ',
                        razaoSocial: 'VITRINE VEICULOS COMERCIO E SERVICOS LTDA',
                        porte: '',
                        situacao: '',
                        areaM2: 75,
                        nivelISSQN: 'VARIAVEL',
                        issqnIsento: false,
                        trimestreAbertura: 1,
                        taxasLancadas: 'NAO',
                        consultado: false,
                        precisaVisa: false
                    },
                    {
                        id: '2',
                        inscricaoMunicipal: '154611',
                        documento: '12345678901',
                        tipoPessoa: 'CPF',
                        razaoSocial: 'JO√ÉO DA SILVA - AUTONOMO',
                        porte: '',
                        situacao: '',
                        areaM2: 0,
                        nivelISSQN: 'SUPERIOR',
                        issqnIsento: false,
                        trimestreAbertura: 2,
                        taxasLancadas: 'NAO',
                        consultado: false
                    }
                ];
                setList(dadosExemplo);
            }, []);

            const consultarCNPJ = async (cnpj, id) => {
                try {
                    const response = await fetch(`https://open.cnpja.com/office/${cnpj}`);
                    
                    if (!response.ok) {
                        throw new Error('Erro na consulta');
                    }
                    
                    const data = await response.json();
                    
                    // Extrair porte
                    let porte = '';
                    if (data.company?.simples?.simei) {
                        porte = 'MEI';
                    } else if (data.company?.size?.text) {
                        const porteAPI = data.company.size.text.toUpperCase();
                        if (porteAPI.includes('MEI')) {
                            porte = 'MEI';
                        } else if (porteAPI.includes('MICRO EMPRESA') || porteAPI.includes('ME')) {
                            porte = 'ME';
                        } else if (porteAPI.includes('EMPRESA DE PEQUENO PORTE') || porteAPI.includes('EPP')) {
                            porte = 'EPP';
                        } else if (porteAPI.includes('DEMAIS')) {
                            porte = 'L. Presumido';
                        } else {
                            porte = 'L. Presumido'; // Default se n√£o identificar
                        }
                    }
                    
                    // Extrair situa√ß√£o cadastral
                    let situacao = '';
                    if (data.status?.text) {
                        const statusAPI = data.status.text.toUpperCase();
                        if (statusAPI.includes('ATIVA')) {
                            situacao = 'ATIVO';
                        } else if (statusAPI.includes('SUSPENS')) {
                            situacao = 'SUSPENSO';
                        } else if (statusAPI.includes('BAIXADA') || statusAPI.includes('INAP')) {
                            situacao = 'BAIXADO';
                        } else {
                            situacao = data.status.text;
                        }
                    }
                    
                    // Verificar se precisa de vigil√¢ncia sanit√°ria
                    const cnaes = [];
                    if (data.activity?.main?.code) {
                        cnaes.push(data.activity.main.code.substring(0, 4));
                    }
                    if (data.activity?.secondaries) {
                        data.activity.secondaries.forEach(sec => {
                            if (sec.code) {
                                cnaes.push(sec.code.substring(0, 4));
                            }
                        });
                    }
                    
                    const precisaVisa = cnaes.some(cnae => CNAES_VISA.includes(cnae));
                    
                    setList(prevList => prevList.map(item => 
                        item.id === id ? { 
                            ...item, 
                            porte,
                            situacao,
                            precisaVisa,
                            consultado: true,
                            dadosAPI: data
                        } : item
                    ));
                    
                    setConsultasRealizadas(prev => prev + 1);
                    setUltimaConsulta(new Date());
                    
                    return { success: true, porte, situacao };
                } catch (error) {
                    console.error('Erro ao consultar CNPJ:', error);
                    return { success: false, error: error.message };
                }
            };

            const consultarTodos = async () => {
                const naoConsultados = list.filter(l => !l.consultado && l.tipoPessoa === 'CNPJ');
                
                if (naoConsultados.length === 0) {
                    alert('Todos os CNPJs j√° foram consultados!');
                    return;
                }
                
                setConsultandoQueue(naoConsultados.map(l => l.id));
                
                for (let i = 0; i < naoConsultados.length; i++) {
                    const item = naoConsultados[i];
                    
                    if (i > 0 && i % 5 === 0) {
                        alert(`Limite de 5 consultas atingido. Aguardando 60 segundos...`);
                        await new Promise(resolve => setTimeout(resolve, 60000));
                    }
                    
                    await consultarCNPJ(item.documento, item.id);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                setConsultandoQueue([]);
                alert(`‚úÖ ${naoConsultados.length} CNPJs consultados com sucesso!`);
            };

            const calcISSQN = (nivel, trimestre, isento, tipoPessoa) => {
                if (isento || tipoPessoa !== 'CPF' || nivel === 'VARIAVEL') return 0;
                const base = nivel === 'SUPERIOR' ? 8 : 5;
                const trimestres = 4 - (trimestre - 1);
                return (base / 4) * trimestres;
            };

            const calcVISA = (area, porte, tipoPessoa, precisaVisa) => {
                if (porte === 'MEI' || porte === 'Isento' || !precisaVisa) return 0;
                if (!area || area === 0) return 0;
                
                const faixa = TABELA_VISA.find(f => area >= f.min && area <= f.max);
                if (!faixa) return 0;
                
                const valorBase = (porte === 'ME' || porte === 'EPP') ? faixa.ME_EPP : faixa.outros;
                
                return valorBase;
            };

            const getPorteUFICAS = (porte, tipoPessoa) => {
                if (porte === 'MEI' || porte === 'Isento') return 0;
                
                const valores = {
                    'MEI': 0,
                    'ME': 2.5,
                    'EPP': 2.5,
                    'L. Presumido': 8,
                    'L. Real': 20,
                    'Isento': 0
                };
                
                if (tipoPessoa === 'CPF') return 2.5;
                
                return valores[porte] || 0;
            };

            const calcTFLFReais = (porte, tipoPessoa) => {
                const uficas = getPorteUFICAS(porte, tipoPessoa);
                return uficas * VALOR_UFICA_2026;
            };

            const calcDashboard = () => {
                const total = list.length;
                const pendentes = list.filter(l => l.taxasLancadas === 'NAO').length;
                const consultados = list.filter(l => l.consultado).length;
                
                const documentos = {};
                const duplicados = [];
                list.forEach(l => {
                    if (documentos[l.documento]) {
                        duplicados.push(l.documento);
                    }
                    documentos[l.documento] = (documentos[l.documento] || 0) + 1;
                });
                const totalDuplicados = new Set(duplicados).size;
                
                let totalUFICAS = 0;
                let totalReais = 0;
                let totalISSQN = 0;
                let porPorte = { MEI: 0, ME: 0, EPP: 0, 'L. Presumido': 0, 'L. Real': 0 };
                
                list.forEach(l => {
                    const uficas = getPorteUFICAS(l.porte, l.tipoPessoa);
                    const reais = uficas * VALOR_UFICA_2026;
                    const issqn = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                    
                    totalUFICAS += uficas;
                    totalReais += reais;
                    totalISSQN += issqn * VALOR_UFICA_2026;
                    
                    if (porPorte[l.porte] !== undefined) {
                        porPorte[l.porte] += uficas;
                    }
                });
                
                const vigilancia = list.reduce((sum, l) => sum + calcVISA(l.areaM2 || 0, l.porte, l.tipoPessoa, l.precisaVisa), 0);

                return { total, pendentes, consultados, totalUFICAS, totalReais, porPorte, vigilancia, totalDuplicados, totalISSQN };
            };

            const importarTXT = (file) => {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const linhas = e.target.result.split('\n');
                    const novosContribuintes = [];
                    
                    for (const l of linhas) {
                        if (!l.trim()) continue;
                        
                        const partes = l.split('\t').map(p => p.trim());
                        const [insc, doc, nome] = partes;
                        
                        if (!doc) continue;
                        
                        const clean = doc.replace(/\D/g, '');
                        novosContribuintes.push({
                            id: Date.now() + Math.random(),
                            inscricaoMunicipal: insc || '',
                            documento: clean,
                            tipoPessoa: clean.length === 11 ? 'CPF' : 'CNPJ',
                            razaoSocial: nome || '',
                            porte: '',
                            areaM2: 0,
                            nivelISSQN: 'MEDIO',
                            issqnIsento: false,
                            trimestreAbertura: 1,
                            taxasLancadas: 'NAO',
                            consultado: false,
                            criadoEm: Date.now()
                        });
                    }
                    
                    setList([...list, ...novosContribuintes]);
                    alert(`‚úÖ ${novosContribuintes.length} contribuintes importados com sucesso!`);
                };
                
                reader.readAsText(file);
            };

            const exportCSV = () => {
                const header = ['Inscri√ß√£o', 'Documento', 'Nome', 'Porte', 'TFLF (UFICAS)', 'TFLF (R$)', 'ISSQN (UFICAS)', 'ISSQN (R$)', 'VISA', 'Taxas Lan√ßadas'];
                const rows = list.map(l => {
                    const uficas = getPorteUFICAS(l.porte, l.tipoPessoa);
                    const tflf = calcTFLFReais(l.porte, l.tipoPessoa);
                    const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                    const issqnReais = issqnUficas * VALOR_UFICA_2026;
                    const visa = calcVISA(l.areaM2 || 0, l.porte, l.tipoPessoa, l.precisaVisa);
                    
                    return [
                        l.inscricaoMunicipal,
                        l.documento,
                        l.razaoSocial,
                        l.porte,
                        uficas.toFixed(1),
                        tflf.toFixed(2),
                        issqnUficas.toFixed(2),
                        issqnReais.toFixed(2),
                        visa.toFixed(2),
                        l.taxasLancadas
                    ];
                });
                
                const csv = [header, ...rows].map(r => r.join(';')).join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `taxas_${mes + 1}_${ano}.csv`;
                a.click();
            };

            const update = (id, campo, valor) => {
                setList(list.map(item => 
                    item.id === id ? { ...item, [campo]: valor } : item
                ));
            };

            const excluir = (id) => {
                if (confirm('Tem certeza que deseja excluir este registro?')) {
                    setList(list.filter(item => item.id !== id));
                }
            };

            const getDuplicados = () => {
                const documentos = {};
                list.forEach(l => {
                    if (!documentos[l.documento]) {
                        documentos[l.documento] = [];
                    }
                    documentos[l.documento].push(l);
                });
                
                return Object.values(documentos).filter(grupo => grupo.length > 1).flat();
            };

            const dashboard = calcDashboard();

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="mb-6">
                        <div className="flex items-center gap-3 mb-4">
                            <span className="text-3xl">üí∞</span>
                            <h2 className="text-2xl font-bold text-gray-800">Lan√ßamento de Taxas</h2>
                        </div>

                        <div className="flex gap-4 mb-4">
                            <select 
                                value={mes}
                                onChange={e => setMes(Number(e.target.value))}
                                className="px-4 py-2 border rounded bg-white"
                            >
                                {MESES.map((m, i) => (
                                    <option key={i} value={i}>{m}</option>
                                ))}
                            </select>

                            <select
                                value={ano}
                                onChange={e => setAno(Number(e.target.value))}
                                className="px-4 py-2 border rounded bg-white"
                            >
                                {[2024, 2025, 2026, 2027].map(a => (
                                    <option key={a} value={a}>{a}</option>
                                ))}
                            </select>

                            <div className="px-4 py-2 bg-blue-50 text-blue-700 rounded border border-blue-200 flex items-center gap-2">
                                üìÖ {MESES[mes]}/{ano}
                            </div>

                            <div className="px-4 py-2 bg-green-50 text-green-700 rounded border border-green-200 flex items-center gap-2 text-sm">
                                üíµ UFICA 2026: R$ {VALOR_UFICA_2026.toFixed(2)}
                            </div>
                        </div>

                        <div className="grid grid-cols-7 gap-4 mb-6">
                            <div className="bg-white rounded-lg p-4 border">
                                <div className="text-sm text-gray-600 mb-1">Total</div>
                                <div className="text-3xl font-bold text-gray-800">{dashboard.total}</div>
                            </div>

                            <div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                <div className="text-sm text-gray-600 mb-1">Pendentes</div>
                                <div className="text-3xl font-bold text-yellow-600">{dashboard.pendentes}</div>
                            </div>

                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                <div className="text-sm text-gray-600 mb-1">Consultados</div>
                                <div className="text-3xl font-bold text-green-600">{dashboard.consultados}</div>
                            </div>

                            <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                <div className="text-sm text-gray-600 mb-1">‚ö†Ô∏è Duplicados</div>
                                <div className="text-3xl font-bold text-orange-600">{dashboard.totalDuplicados}</div>
                            </div>

                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <div className="text-sm text-gray-600 mb-1">Total TFLF</div>
                                <div className="text-3xl font-bold text-blue-600">{dashboard.totalUFICAS.toFixed(1)}</div>
                                <div className="text-xs text-gray-500 mt-1">R$ {dashboard.totalReais.toFixed(2)}</div>
                            </div>

                            <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                                <div className="text-sm text-gray-600 mb-1">Total ISSQN</div>
                                <div className="text-3xl font-bold text-indigo-600">R$ {dashboard.totalISSQN.toFixed(2)}</div>
                            </div>

                            <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                <div className="text-sm text-gray-600 mb-1">Vigil√¢ncia</div>
                                <div className="text-3xl font-bold text-purple-600">R$ {dashboard.vigilancia.toFixed(2)}</div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                            <div className="flex gap-2 mb-4 border-b">
                                <button
                                    onClick={() => setAbaAtiva('principal')}
                                    className={`px-4 py-2 font-medium transition ${
                                        abaAtiva === 'principal'
                                            ? 'text-blue-600 border-b-2 border-blue-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    üìã Principal ({list.length})
                                </button>
                                <button
                                    onClick={() => setAbaAtiva('duplicados')}
                                    className={`px-4 py-2 font-medium transition ${
                                        abaAtiva === 'duplicados'
                                            ? 'text-orange-600 border-b-2 border-orange-600'
                                            : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    ‚ö†Ô∏è Duplicidade ({dashboard.totalDuplicados})
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-4 items-center justify-between">
                                <div className="flex gap-2">
                                    <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded cursor-pointer hover:bg-blue-700 transition">
                                        <span>üìÅ Importar TXT</span>
                                        <input 
                                            type="file" 
                                            accept=".txt" 
                                            onChange={e => importarTXT(e.target.files[0])}
                                            className="hidden"
                                        />
                                    </label>
                                    
                                    <button 
                                        onClick={consultarTodos}
                                        className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition flex items-center gap-2"
                                        disabled={consultandoQueue.length > 0}
                                    >
                                        {consultandoQueue.length > 0 ? 'üîÑ Consultando...' : 'üîç Consultar CNPJs'}
                                    </button>
                                    
                                    <button 
                                        onClick={exportCSV}
                                        className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
                                    >
                                        üìä Exportar CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-indigo-600 text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left">Status</th>
                                            <th className="px-4 py-3 text-left">Inscri√ß√£o</th>
                                            <th className="px-4 py-3 text-left">Documento</th>
                                            <th className="px-4 py-3 text-left">Nome</th>
                                            <th className="px-4 py-3 text-center">Situa√ß√£o</th>
                                            <th className="px-4 py-3 text-center">Porte</th>
                                            <th className="px-4 py-3 text-center">VISA?</th>
                                            <th className="px-4 py-3 text-center">√Årea (m¬≤)</th>
                                            <th className="px-4 py-3 text-center">N√≠vel ISSQN</th>
                                            <th className="px-4 py-3 text-center">Trimestre</th>
                                            <th className="px-4 py-3 text-center">TFLF</th>
                                            <th className="px-4 py-3 text-center">ISSQN</th>
                                            <th className="px-4 py-3 text-center">VISA</th>
                                            <th className="px-4 py-3 text-center">Lan√ßado</th>
                                            <th className="px-4 py-3 text-center">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(() => {
                                            const listaExibir = abaAtiva === 'duplicados' ? getDuplicados() : list;
                                            
                                            if (listaExibir.length === 0) {
                                                return (
                                                    <tr>
                                                        <td colSpan="15" className="px-4 py-8 text-center text-gray-500">
                                                            {abaAtiva === 'duplicados' 
                                                                ? '‚úÖ Nenhum registro duplicado encontrado!' 
                                                                : 'Nenhum contribuinte cadastrado. Importe um arquivo TXT para come√ßar.'}
                                                        </td>
                                                    </tr>
                                                );
                                            }
                                            
                                            return listaExibir.map(l => {
                                                const tflf = calcTFLFReais(l.porte, l.tipoPessoa);
                                                const issqnUficas = calcISSQN(l.nivelISSQN, l.trimestreAbertura || 1, l.issqnIsento, l.tipoPessoa);
                                                const issqnReais = issqnUficas * VALOR_UFICA_2026;
                                                const visa = calcVISA(l.areaM2 || 0, l.porte, l.tipoPessoa, l.precisaVisa);
                                                const consultando = consultandoQueue.includes(l.id);
                                                const isDuplicado = getDuplicados().some(d => d.id === l.id);

                                                return (
                                                    <tr key={l.id} className={`border-t hover:bg-gray-50 ${isDuplicado && abaAtiva === 'duplicados' ? 'bg-orange-50' : ''}`}>
                                                        <td className="px-4 py-3 text-center">
                                                            {consultando ? (
                                                                <span className="text-blue-600">üîÑ</span>
                                                            ) : l.consultado ? (
                                                                <span className="text-green-600">‚úÖ</span>
                                                            ) : isDuplicado ? (
                                                                <span className="text-orange-600">‚ö†Ô∏è</span>
                                                            ) : (
                                                                <span className="text-gray-400">‚è≥</span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3">{l.inscricaoMunicipal}</td>
                                                        <td className="px-4 py-3 font-mono text-sm">{l.documento}</td>
                                                        <td className="px-4 py-3">{l.razaoSocial}</td>
                                                        
                                                        <td className="px-4 py-3 text-center">
                                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                                                l.situacao === 'ATIVO' ? 'bg-green-100 text-green-700' :
                                                                l.situacao === 'SUSPENSO' ? 'bg-yellow-100 text-yellow-700' :
                                                                l.situacao === 'BAIXADO' ? 'bg-red-100 text-red-700' :
                                                                'bg-gray-100 text-gray-700'
                                                            }`}>
                                                                {l.situacao || '-'}
                                                            </span>
                                                        </td>
                                                        
                                                        <td className="px-4 py-3 text-center">
                                                            <select
                                                                value={l.porte}
                                                                onChange={e => update(l.id, 'porte', e.target.value)}
                                                                className="px-2 py-1 border rounded bg-white text-sm"
                                                            >
                                                                <option value="">Selecione</option>
                                                                <option value="MEI">MEI</option>
                                                                <option value="ME">ME</option>
                                                                <option value="EPP">EPP</option>
                                                                <option value="L. Presumido">L. Presumido</option>
                                                                <option value="L. Real">L. Real</option>
                                                                <option value="Isento">Isento</option>
                                                            </select>
                                                        </td>

                                                        <td className="px-4 py-3 text-center">
                                                            <input
                                                                type="checkbox"
                                                                checked={l.precisaVisa || false}
                                                                onChange={e => update(l.id, 'precisaVisa', e.target.checked)}
                                                                className="w-4 h-4 cursor-pointer"
                                                            />
                                                        </td>

                                                        <td className="px-4 py-3 text-center">
                                                            <input
                                                                type="number"
                                                                value={l.areaM2 || ''}
                                                                onChange={e => update(l.id, 'areaM2', Number(e.target.value))}
                                                                className="px-2 py-1 border rounded w-16 text-sm"
                                                                disabled={!l.precisaVisa}
                                                            />
                                                        </td>

                                                        <td className="px-4 py-3 text-center">
                                                            <select
                                                                value={l.nivelISSQN}
                                                                onChange={e => update(l.id, 'nivelISSQN', e.target.value)}
                                                                className="px-2 py-1 border rounded text-sm"
                                                                disabled={l.tipoPessoa === 'CNPJ'}
                                                            >
                                                                {l.tipoPessoa === 'CNPJ' ? (
                                                                    <option value="VARIAVEL">Vari√°vel</option>
                                                                ) : (
                                                                    <>
                                                                        <option value="MEDIO">M√©dio</option>
                                                                        <option value="SUPERIOR">Superior</option>
                                                                    </>
                                                                )}
                                                            </select>
                                                        </td>

                                                        <td className="px-4 py-3 text-center">
                                                            <input
                                                                type="number"
                                                                min="1"
                                                                max="4"
                                                                value={l.trimestreAbertura || 1}
                                                                onChange={e => update(l.id, 'trimestreAbertura', Number(e.target.value))}
                                                                className="px-2 py-1 border rounded w-12 text-sm"
                                                            />
                                                        </td>

                                                        <td className="px-4 py-3 text-center">{tflf.toFixed(2)}</td>
                                                        <td className="px-4 py-3 text-center">{issqnReais.toFixed(2)}</td>
                                                        <td className="px-4 py-3 text-center">{visa.toFixed(2)}</td>
                                                        <td className="px-4 py-3 text-center">
                                                            <select
                                                                value={l.taxasLancadas}
                                                                onChange={e => update(l.id, 'taxasLancadas', e.target.value)}
                                                                className={`px-2 py-1 border rounded text-sm font-semibold ${
                                                                    l.taxasLancadas === 'SIM' ? 'bg-green-50 text-green-700 border-green-300' : 'bg-yellow-50 text-yellow-700 border-yellow-300'
                                                                }`}
                                                            >
                                                                <option value="NAO">N√ÉO</option>
                                                                <option value="SIM">SIM</option>
                                                            </select>
                                                        </td>
                                                        <td className="px-4 py-3 text-center flex justify-center gap-2">
                                                            <button
                                                                onClick={() => excluir(l.id)}
                                                                className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs"
                                                            >
                                                                üóëÔ∏è
                                                            </button>
                                                            {l.tipoPessoa === 'CNPJ' && !l.consultado && (
                                                                <button
                                                                    onClick={() => consultarCNPJ(l.documento, l.id)}
                                                                    className="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs"
                                                                >
                                                                    üîç
                                                                </button>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            });
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
